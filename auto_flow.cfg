[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Blob Detect | Dynamic PA | Z-Watcher
# =========================================================
#  USER CONFIGURATION (edit these variables)
#  NOTE: This script is designed for E3D Revo hotends only
# =========================================================
#
# HOTEND TYPE (Revo Only)
# -----------------------
# Set to True for Revo HF (High Flow) nozzles
# Set to False for Revo Standard nozzles
# This affects the flow gate threshold:
#   - Revo HF: enables boost only above 15mm³/s (matches HF flow capacity)
#   - Revo Std: enables boost above 8mm³/s (matches standard flow capacity)
variable_use_high_flow_nozzle: True
#
# SENSOR BASELINE (StallGuard calibration)
# ----------------------------------------
# This system uses G-code lookahead and live velocity data only.
# No TMC StallGuard / extruder load sensor required.
#
# ADVANCED TUNING
# ---------------
# flow_smoothing: Exponential smoothing factor for volumetric flow (0.0-1.0)
#   - Higher = more smoothing, slower response, less jitter
#   - Lower = faster response, may oscillate on variable flow
#   - 0.3 is good for fast infill response, 0.5 for stability
variable_flow_smoothing: 0.3
#
# max_boost_limit: Maximum temperature boost above base temp (°C)
#   - Safety cap to prevent runaway heating
#   - 50°C allows base 200 to reach 250 max
variable_max_boost_limit: 50.0
#
# ramp_rate_rise: Max temp increase per loop cycle (°C/second)
#   - Higher = faster response to increased flow demand
#   - Too high may overshoot on brief speed bursts
#   - 4.0 is aggressive for fast infill, 2.0 is conservative
variable_ramp_rate_rise: 4.0
#
# ramp_rate_fall: Max temp decrease per loop cycle (°C/second)
#   - Lower = slower cooldown, maintains heat during brief pauses
#   - Higher = faster return to base temp, saves energy
#   - Keep lower than rise rate for stability
variable_ramp_rate_fall: 0.2
#
# THERMAL SAFETY
# --------------
# thermal_runaway_threshold: Max deviation from target before emergency stop (°C)
#   - If actual temp exceeds target + this value, system triggers emergency
#   - Set based on your hotend's thermal characteristics
#   - 15°C is conservative, increase for hotends with slow response
variable_thermal_runaway_threshold: 15.0
#
# thermal_undertemp_threshold: Min temp below target before warning (°C)
#   - If actual temp drops below target - this value during active printing,
#     the system will reduce boost and warn
#   - Helps detect heater issues or cooling problems
variable_thermal_undertemp_threshold: 10.0
#
# thermal_check_interval: Seconds between thermal safety checks
#   - Lower = more responsive but more CPU usage
variable_thermal_check_interval: 2.0
#
#
# ZERO-CONFIG / AUTO-LEARNING
# ----------------------------
# auto_material_detect: Infer material type from slicer temperature
#   - Eliminates need for MATERIAL= parameter
variable_auto_material_detect: True
#
# self_learning_enabled: Auto-adjust K-values based on thermal response
#   - Learns optimal settings over time
variable_self_learning_enabled: True
#
# learning_rate: How aggressively to adjust K-values (0.01-0.1)
#   - Lower = more stable, slower learning
#   - Higher = faster adaptation, may oscillate
variable_learning_rate: 0.05
#
# =========================================================
variable_current_boost: 0.0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_last_vol_flow: 0.0
variable_thermal_fault_count: 0
variable_last_thermal_check: 0.0
variable_detected_material: "UNKNOWN"
variable_thermal_lag_samples: 0
variable_thermal_lag_sum: 0.0
variable_enabled: False
variable_accumulated_travel: 0.0

gcode:
    # =========================================================
    #  READ CONFIGURATION FROM VARIABLES ABOVE
    # =========================================================
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set use_high_flow_nozzle = cfg.use_high_flow_nozzle %}
    
    {% set vars = printer.save_variables.variables %}
    {% set flow_smoothing = cfg.flow_smoothing %}
    {% set max_boost_limit = cfg.max_boost_limit %}
    {% set ramp_rate_rise = cfg.ramp_rate_rise %}
    {% set ramp_rate_fall = cfg.ramp_rate_fall %}
    {% set thermal_runaway_threshold = cfg.thermal_runaway_threshold %}
    {% set thermal_undertemp_threshold = cfg.thermal_undertemp_threshold %}

    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # Auto-Calculate Flow Gate (minimum flow to trigger boost)
    # Set very low - just above noise level
    {% if use_high_flow_nozzle %}
        {% set min_flow_mm3 = 3.0 %}
    {% else %}
        {% set min_flow_mm3 = 2.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: GET LOOKAHEAD DATA ---
        {% set predicted_rate = printer["extruder_monitor"].predicted_extrusion_rate|default(0.0)|float %}

        # --- C: CALCULATE BOOST (Velocity + Acceleration + Lookahead) ---
        
        # 1. Calculate Flow from live velocity
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        
        # 2. Smoothing
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}
        
        # 3. ACCELERATION KICK (Predictive Boost)
        {% set flow_accel = raw_vol_flow - last_vol_flow %}
        {% set accel_boost = 0.0 %}
        {% if flow_accel > 2.0 %}
            {% set accel_boost = flow_accel * 2.0 %}
        {% endif %}

        # 4. LOOKAHEAD BOOST (Predictive from upcoming G-code)
        {% set predicted_vol_flow = predicted_rate * 2.405 %}
        {% set lookahead_boost = 0.0 %}
        {% if predicted_vol_flow > smooth_vol_flow %}
            {% set lookahead_delta = predicted_vol_flow - smooth_vol_flow %}
            {% set lookahead_boost = lookahead_delta * 0.5 %}
        {% endif %}

        # 5. Flow-Based Boost
        {% set speed_k = vars.material_flow_k|default(0.0)|float %}
        
        # Gated Logic - only boost above minimum flow
        {% if smooth_vol_flow < min_flow_mm3 %}
            {% set speed_boost = 0.0 %}
        {% else %}
            {% set speed_boost = smooth_vol_flow * speed_k %}
        {% endif %}

        # --- D: SMOOTHING & RAMPING ---
        
        # Total boost = flow boost + acceleration kick + lookahead prediction
        {% set raw_boost_target = speed_boost + accel_boost + lookahead_boost %}
        
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        # Linear Ramp Safety
        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}
        
        # --- E: APPLY TEMPERATURE ---
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}
        {% if new_target < saved_base %} {% set new_target = saved_base|int %} {% endif %}

        # Only update if temp changed by at least 1°C
        {% set temp_diff = (new_target - current_setpoint)|abs %}
        {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}

        # --- F: THERMAL SAFETY CHECK ---
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set target_temp = printer.extruder.target|float %}
        {% set temp_deviation = actual_temp - target_temp %}
        
        # Check for thermal runaway (temp too high)
        {% if temp_deviation > thermal_runaway_threshold %}
            {% set fault_count = printer["gcode_macro _AUTO_TEMP_CORE"].thermal_fault_count + 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE={fault_count}
            
            {% if fault_count >= 3 %}
                # Multiple consecutive faults - emergency shutdown
                _AT_THERMAL_EMERGENCY reason="RUNAWAY" actual={actual_temp} target={target_temp}
            {% else %}
                # Single fault - reduce boost and warn
                RESPOND TYPE=error MSG="THERMAL WARNING: Temp {actual_temp}C exceeds target {target_temp}C by {temp_deviation|round(1)}C"
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
                M104 S{saved_base|int}  ; Drop to base temp immediately
            {% endif %}
        
        # Check for undertemp (heater not keeping up)
        {% elif temp_deviation < (0 - thermal_undertemp_threshold) %}
            RESPOND TYPE=echo MSG="THERMAL NOTICE: Temp {actual_temp}C is {(0-temp_deviation)|round(1)}C below target. Heater may be struggling."
            # Don't add more boost if heater can't keep up - reduce demand
            {% if smooth_boost > 10 %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost * 0.5}
            {% endif %}
        
        {% else %}
            # Temp is within safe range - reset fault counter
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
        {% endif %}

        # --- G: SELF-LEARNING K-VALUE ADJUSTMENT ---
        # Monitors thermal response and adjusts K-values to optimize over time
        {% set self_learn = cfg.self_learning_enabled %}
        {% set learn_rate = cfg.learning_rate %}
        
        {% if self_learn and smooth_boost > 1.0 %}
            # We're actively boosting - monitor how well temp follows
            {% set thermal_error = target_temp - actual_temp %}  # Positive = too cold
            
            # Only learn when we have significant demand
            {% if smooth_vol_flow > min_flow_mm3 %}
                {% set lag_samples = cfg.thermal_lag_samples %}
                {% set lag_sum = cfg.thermal_lag_sum %}
                
                # Track thermal error for learning
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE={lag_samples + 1}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE={lag_sum + thermal_error}
                
                # Every 50 samples, evaluate and potentially adjust
                {% if lag_samples > 0 and (lag_samples % 50) == 0 %}
                    {% set avg_error = lag_sum / lag_samples %}
                    
                    {% if avg_error > 3.0 %}
                        # Consistently too cold - heater can't keep up
                        # Increase speed_k to boost temp earlier
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k + learn_rate %}
                        {% if new_speed_k > 2.0 %}
                            {% set new_speed_k = 2.0 %}  # Cap at reasonable max
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg thermal lag {avg_error|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% elif avg_error < -3.0 %}
                        # Consistently too hot - reduce boost aggressiveness
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k - learn_rate %}
                        {% if new_speed_k < 0.1 %}
                            {% set new_speed_k = 0.1 %}  # Don't go below minimum
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg overshoot {(0-avg_error)|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% endif %}
                    
                    # Reset for next learning window
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
                {% endif %}
            {% endif %}
        {% endif %}

        # Pressure Advance
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if base_pa > 0 %}
            {% set pa_multiplier = 1.0 - (smooth_boost * 0.01) %}
            {% if pa_multiplier < 0.5 %} {% set pa_multiplier = 0.5 %} {% endif %}
            {% set new_pa = base_pa * pa_multiplier %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.01 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. THERMAL SAFETY
# =========================================================
# =========================================================
[gcode_macro _AT_THERMAL_EMERGENCY]
description: Emergency thermal shutdown - called when runaway detected
gcode:
    {% set reason = params.REASON|default("UNKNOWN")|string %}
    {% set actual = params.ACTUAL|default(0)|float %}
    {% set target = params.TARGET|default(0)|float %}
    
    # Immediately disable auto-temp
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    
    # Turn off heater (set to 0)
    M104 S0
    
    # Pause print
    PAUSE
    
    # Alert user
    RESPOND TYPE=error MSG="!!! THERMAL EMERGENCY !!!"
    RESPOND TYPE=error MSG="Reason: {reason}"
    RESPOND TYPE=error MSG="Actual: {actual}C | Target: {target}C"
    RESPOND TYPE=error MSG="Heater OFF - Print PAUSED - Auto-Temp DISABLED"
    RESPOND TYPE=error MSG="Check hotend and thermistor before resuming!"
    
    M117 THERMAL EMERGENCY - CHECK HOTEND!

[gcode_macro AT_THERMAL_STATUS]
description: Display current thermal safety status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set actual = printer.extruder.temperature|float %}
    {% set target = printer.extruder.target|float %}
    {% set base = vars.base_print_temp|default(0)|float %}
    {% set boost = cfg.current_boost %}
    {% set faults = cfg.thermal_fault_count %}
    
    {% set deviation = actual - target %}
    {% set runaway_limit = cfg.thermal_runaway_threshold %}
    {% set undertemp_limit = cfg.thermal_undertemp_threshold %}
    
    RESPOND MSG="===== THERMAL STATUS ====="
    RESPOND MSG="Actual: {actual|round(1)}C | Target: {target|round(1)}C"
    RESPOND MSG="Base: {base|round(1)}C | Boost: +{boost|round(1)}C"
    RESPOND MSG="Deviation: {deviation|round(1)}C"
    RESPOND MSG="Limits: Runaway +{runaway_limit}C | Undertemp -{undertemp_limit}C"
    RESPOND MSG="Fault Count: {faults}/3"
    {% if vars.at_enabled|default(False) %}
        RESPOND MSG="Status: ACTIVE"
    {% else %}
        RESPOND MSG="Status: DISABLED"
    {% endif %}
    RESPOND MSG="=========================="

[gcode_macro AT_STATUS]
description: Display full Adaptive Flow system status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    
    # System state
    {% set enabled = vars.at_enabled|default(False) %}
    {% set base_temp = vars.base_print_temp|default(0)|float %}
    {% set max_temp = vars.at_max_temp|default(300)|int %}
    {% set flow_k = vars.material_flow_k|default(0)|float %}
    
    # Current values from macro state
    {% set boost = cfg.current_boost %}
    {% set fault_count = cfg.thermal_fault_count %}
    
    # Configuration
    {% set use_hf = cfg.use_high_flow_nozzle %}
    
    # Thermal info
    {% set actual_temp = printer.extruder.temperature|float %}
    {% set target_temp = printer.extruder.target|float %}
    {% set current_pa = printer.extruder.pressure_advance|default(0)|float %}
    {% set base_pa = cfg.base_pa|default(0)|float %}
    
    # Flow and lookahead data
    {% set predicted = printer.extruder_monitor.predicted_extrusion_rate|default(0)|float %}
    {% set last_vol_flow = cfg.last_vol_flow|default(0)|float %}
    
    RESPOND MSG="╔═══════════════════════════════════════════╗"
    RESPOND MSG="║      ADAPTIVE FLOW STATUS                 ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    
    # System State
    {% if enabled %}
        RESPOND MSG="║ System: ✓ ENABLED                         ║"
    {% else %}
        RESPOND MSG="║ System: ✗ DISABLED                        ║"
    {% endif %}
    
    # Hotend Type
    {% if use_hf %}
        RESPOND MSG="║ Hotend: Revo HF (High Flow)               ║"
    {% else %}
        RESPOND MSG="║ Hotend: Revo Standard                     ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ TEMPERATURE                               ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Actual:    {"%6.1f"|format(actual_temp)}°C                        ║"
    RESPOND MSG="║ Target:    {"%6.1f"|format(target_temp)}°C                        ║"
    RESPOND MSG="║ Base:      {"%6.1f"|format(base_temp)}°C                        ║"
    RESPOND MSG="║ Boost:     {"%+6.1f"|format(boost)}°C                        ║"
    RESPOND MSG="║ Max Limit: {"%6d"|format(max_temp)}°C                        ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ PRESSURE ADVANCE                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Current PA: {"%6.3f"|format(current_pa)}                         ║"
    RESPOND MSG="║ Base PA:    {"%6.3f"|format(base_pa)}                         ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ FLOW & LOOKAHEAD                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Flow K:      {"%6.2f"|format(flow_k)}                         ║"
    RESPOND MSG="║ Current Flow:{"%6.2f"|format(last_vol_flow)} mm³/s               ║"
    {% if predicted > 0 %}
        RESPOND MSG="║ Predicted:   {"%6.2f"|format(predicted)} mm/s                  ║"
    {% else %}
        RESPOND MSG="║ Predicted:   ------ (idle)                 ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SAFETY                                    ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Thermal Faults: {fault_count}/3                        ║"
    
    RESPOND MSG="╚═══════════════════════════════════════════╝"

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=2.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: State reset complete"

    
[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
description: Set the flow-based temperature boost coefficient
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={k}
    RESPOND MSG="Flow K set to {k}"

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_INIT_MATERIAL]
description: Logic to set K-values and PA based on material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Read hotend type from shared config variable in _AUTO_TEMP_CORE
    {% set use_hf = printer["gcode_macro _AUTO_TEMP_CORE"].use_high_flow_nozzle %}
    
    # =========================================================
    # DEFAULT PA VALUES (used if user hasn't calibrated)
    # These are reasonable starting points - calibrate for best results!
    # =========================================================
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    # Defaults
    {% set speed_k = 0.0 %}
    {% set max_temp_safety = 300 %}

    # =========================================================
    # GET PA: User-calibrated value OR default
    # =========================================================
    # Check for exact material match first, then partial match
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    {% if saved_pa >= 0 %}
        # User has calibrated this material
        {% set pa_val = saved_pa %}
        {% set pa_source = "calibrated" %}
    {% else %}
        # Use default - check for partial match in material name
        {% set pa_val = 0.0 %}
        {% set pa_source = "default" %}
        {% for mat_name, mat_pa in default_pa.items() %}
            {% if mat_name in material %}
                {% set pa_val = mat_pa %}
            {% endif %}
        {% endfor %}
    {% endif %}

    # --- PLA LOGIC ---
    # Temperature boost is driven by flow rate (speed_k)
    {% if 'PLA' in material %}
        {% if use_hf %}
            {% set speed_k = 0.80 %}
            {% set max_temp_safety = 235 %}
        {% else %}
            {% set speed_k = 0.40 %} 
            {% set max_temp_safety = 235 %}
        {% endif %}

    # --- PETG LOGIC ---
    # PETG is more viscous and needs aggressive temp boost at high flow
    {% elif 'PETG' in material %}
        {% if use_hf %}
            {% set speed_k = 2.00 %}
            {% set max_temp_safety = 280 %}
        {% else %}
            {% set speed_k = 1.80 %}
            {% set max_temp_safety = 270 %}
        {% endif %}

    # --- ABS/ASA LOGIC ---
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set speed_k = 0.80 %}
        {% set max_temp_safety = 290 %}
        
    # --- TPU LOGIC ---
    {% elif 'TPU' in material %}
        {% set speed_k = 0.0 %}  # Disable boost for flexible
        {% set max_temp_safety = 240 %}
        
    # --- NYLON LOGIC ---
    {% elif 'NYLON' in material %}
        {% set speed_k = 0.90 %}
        {% set max_temp_safety = 275 %}
        
    # --- PC LOGIC ---
    {% elif 'PC' in material %}
        {% set speed_k = 0.70 %}
        {% set max_temp_safety = 300 %}
    {% endif %}

    # --- APPLY ---
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
        RESPOND MSG="PA: {pa_val} ({pa_source})"
    {% endif %}

    {% if speed_k > 0 %}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material}) - K={speed_k}"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"
    {% endif %}

# =========================================================
#  PA CALIBRATION MACROS
# =========================================================
[gcode_macro AT_SET_PA]
description: Save calibrated PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper|replace(" ", "_") %}
    {% set pa = params.PA|default(0.04)|float %}
    
    {% if pa < 0 or pa > 1.0 %}
        RESPOND TYPE=error MSG="PA value must be between 0 and 1.0"
    {% else %}
        SAVE_VARIABLE VARIABLE=pa_{material|lower} VALUE={pa}
        RESPOND MSG="Saved PA for {material}: {pa}"
        RESPOND MSG="This will be used next time you run AT_INIT_MATERIAL MATERIAL={material}"
    {% endif %}

[gcode_macro AT_GET_PA]
description: Show saved or default PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    RESPOND MSG="===== PA for {material} ====="
    {% if saved_pa >= 0 %}
        RESPOND MSG="Saved (calibrated): {saved_pa}"
    {% else %}
        RESPOND MSG="Saved: None (not calibrated)"
    {% endif %}
    
    {% set def_val = default_pa[material]|default(0)|float %}
    {% if def_val > 0 %}
        RESPOND MSG="Default: {def_val}"
    {% else %}
        RESPOND MSG="Default: None (unknown material)"
    {% endif %}
    
    {% if saved_pa >= 0 %}
        RESPOND MSG="Will use: {saved_pa} (calibrated)"
    {% elif def_val > 0 %}
        RESPOND MSG="Will use: {def_val} (default)"
    {% else %}
        RESPOND MSG="Will use: 0 (no PA)"
    {% endif %}

[gcode_macro AT_LIST_PA]
description: List all saved PA values and defaults
gcode:
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    RESPOND MSG="===== PRESSURE ADVANCE VALUES ====="
    RESPOND MSG="Material | Saved | Default"
    RESPOND MSG="---------|-------|--------"
    {% for mat, def_pa in default_pa.items() %}
        {% set saved = vars["pa_" ~ mat|lower]|default(-1)|float %}
        {% if saved >= 0 %}
            RESPOND MSG="{mat}: {saved} (calibrated) | {def_pa}"
        {% else %}
            RESPOND MSG="{mat}: - | {def_pa}"
        {% endif %}
    {% endfor %}
    RESPOND MSG="===================================="
    RESPOND MSG="To calibrate: AT_SET_PA MATERIAL=<name> PA=<value>"
# =========================================================================
# ZERO-CONFIG ENTRY POINT
# =========================================================================
# AT_START: The ONLY macro you need in your slicer's start g-code!
# This automatically detects material from temperature, applies appropriate
# K-values and PA, and enables adaptive flow. True plug-and-play.
# =========================================================================

[gcode_macro AT_START]
description: Zero-config adaptive temperature - just call this in your start g-code!
gcode:
    # Get extruder target temperature (set by slicer before this macro runs)
    {% set target_temp = printer.extruder.target|default(0)|int %}
    {% set vars = printer.save_variables.variables %}
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    
    # Warn if no temperature set (AT_START called before heating commands)
    {% if target_temp < 150 %}
        RESPOND TYPE=echo MSG="AT_START: Warning - extruder target is {target_temp}C. Call AT_START AFTER your heating commands (M104/M109)."
        {% set target_temp = 200 %}  # Default to PLA temp
    {% endif %}
    
    # Auto-detect material from temperature if enabled
    {% set auto_detect = cfg.auto_material_detect %}
    {% set detected = "PLA" %}  # Default fallback
    
    {% if auto_detect %}
        # Temperature-based material detection
        # Ranges overlap slightly - we pick the most common material for that temp
        {% if target_temp >= 280 %}
            {% set detected = "PC" %}        # 280-310°C: Polycarbonate
        {% elif target_temp >= 260 %}
            {% set detected = "NYLON" %}     # 260-280°C: Nylon
        {% elif target_temp >= 240 %}
            {% set detected = "ABS" %}       # 240-270°C: ABS/ASA
        {% elif target_temp >= 220 %}
            {% set detected = "PETG" %}      # 220-245°C: PETG
        {% elif target_temp >= 180 %}
            {% set detected = "PLA" %}       # 180-220°C: PLA
        {% elif target_temp >= 160 %}
            {% set detected = "TPU" %}       # 160-230°C: TPU (low end hint)
        {% else %}
            {% set detected = "PLA" %}       # Default
        {% endif %}
        
        # Store detected material
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=detected_material VALUE="'{detected}'"
        
        RESPOND MSG="AT_START: Detected material '{detected}' from temp {target_temp}°C"
    {% endif %}
    
    # Initialize material settings (K-values, PA, safety limits)
    AT_INIT_MATERIAL MATERIAL={detected}
    
    # Enable adaptive flow
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=True
    
    RESPOND MSG="AT_START: Adaptive Temperature enabled for {detected}"

[gcode_macro AT_END]
description: Clean shutdown of adaptive temperature at print end
gcode:
    # Disable adaptive flow
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=False
    
    # Report any learned values if self-learning was active
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set lag_samples = cfg.thermal_lag_samples %}
    
    {% if lag_samples > 0 %}
        {% set avg_lag = cfg.thermal_lag_sum / lag_samples %}
        RESPOND MSG="AT_END: Avg thermal error: {avg_lag|round(2)}C over {lag_samples} samples (negative=overshoot)"
    {% endif %}
    
    # Reset per-print state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    
    RESPOND MSG="AT_END: Adaptive Temperature disabled"