[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# Include material profiles (user-editable)
[include material_profiles.cfg]

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Blob Detect | Dynamic PA | Z-Watcher
# =========================================================
#  USER CONFIGURATION (edit these variables)
#  NOTE: This script is designed for E3D Revo hotends only
# =========================================================
#
# HOTEND TYPE (Revo Only)
# -----------------------
# Set to True for Revo HF (High Flow) nozzles
# Set to False for Revo Standard nozzles
# This affects the flow gate threshold:
#   - Revo HF: enables boost only above 15mm³/s (matches HF flow capacity)
#   - Revo Std: enables boost above 8mm³/s (matches standard flow capacity)
variable_use_high_flow_nozzle: True
#
# SENSOR BASELINE (StallGuard calibration)
# ----------------------------------------
# This system uses G-code lookahead and live velocity data only.
# No TMC StallGuard / extruder load sensor required.
#
# ADVANCED TUNING
# ---------------
# flow_smoothing: Exponential smoothing factor for volumetric flow (0.0-1.0)
#   - Higher = more smoothing, slower response, less jitter
#   - Lower = faster response, may oscillate on variable flow
#   - 0.15 is responsive for speed changes, 0.3 for stability
variable_flow_smoothing: 0.15
#
# max_boost_limit: Maximum temperature boost above base temp (°C)
#   - Safety cap to prevent runaway heating
#   - 50°C allows base 200 to reach 250 max
variable_max_boost_limit: 50.0
#
# ramp_rate_rise: Max temp increase per loop cycle (°C/second)
#   - Higher = faster response to increased flow demand
#   - Too high may overshoot on brief speed bursts
#   - 4.0 is aggressive for fast infill, 2.0 is conservative
variable_ramp_rate_rise: 4.0
#
# ramp_rate_fall: Max temp decrease per loop cycle (°C/second)
#   - Lower = slower cooldown, maintains heat during brief pauses
#   - Higher = faster return to base temp, reduces corner bulge
#   - Keep lower than rise rate for stability
variable_ramp_rate_fall: 1.0
#
# SPEED-BASED BOOST
# -----------------
# High linear speeds need heat even with low volumetric flow (thin walls)
# speed_boost_threshold: Linear speed (mm/s) above which speed boost activates
variable_speed_boost_threshold: 100.0
#
# speed_boost_k: Temperature boost per mm/s above threshold
#   - At 200mm/s with threshold 100 and k=0.08: (200-100)*0.08 = 8°C boost
#   - At 300mm/s with threshold 100 and k=0.08: (300-100)*0.08 = 16°C boost
variable_speed_boost_k: 0.08
#
# THERMAL SAFETY
# --------------
# thermal_runaway_threshold: Max deviation from target before emergency stop (°C)
#   - If actual temp exceeds target + this value, system triggers emergency
#   - Set based on your hotend's thermal characteristics
#   - 15°C is conservative, increase for hotends with slow response
variable_thermal_runaway_threshold: 15.0
#
# thermal_undertemp_threshold: Min temp below target before warning (°C)
#   - If actual temp drops below target - this value during active printing,
#     the system will reduce boost and warn
#   - Helps detect heater issues or cooling problems
variable_thermal_undertemp_threshold: 10.0
#
# thermal_check_interval: Seconds between thermal safety checks
#   - Lower = more responsive but more CPU usage
variable_thermal_check_interval: 2.0
#
#
# ZERO-CONFIG / AUTO-LEARNING
# ----------------------------
# auto_material_detect: Infer material type from slicer temperature
#   - Eliminates need for MATERIAL= parameter
variable_auto_material_detect: True
#
# self_learning_enabled: Auto-adjust K-values based on thermal response
#   - Learns optimal settings over time
variable_self_learning_enabled: True
#
# pa_auto_learning: Experimental - auto-tune PA based on corner thermal behavior
#   - Monitors temperature after sharp corners
#   - Temp drops after corner = too much PA (under-extrusion)
#   - Temp rises after corner = too little PA (over-extrusion)
variable_pa_auto_learning: True
#
# pa_learning_rate: How aggressively to adjust PA (0.001-0.01)
#   - Very small adjustments to avoid oscillation
variable_pa_learning_rate: 0.002
#
# learning_rate: How aggressively to adjust K-values (0.01-0.1)
#   - Lower = more stable, slower learning
#   - Higher = faster adaptation, may oscillate
variable_learning_rate: 0.05
#
# FIRST LAYER MODE
# -----------------
# Automatically disables boost on layer 1 for consistent squish
# Uses slicer layer info if available, falls back to Z height
# Set to False to allow boost on first layer
variable_first_layer_skip: True
#
# first_layer_height: Fallback if slicer doesn't send layer info (mm)
#   - Used when print_stats.info.current_layer is not available
variable_first_layer_height: 0.3
#
# =========================================================
variable_current_boost: 0.0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_last_vol_flow: 0.0
variable_thermal_fault_count: 0
variable_last_thermal_check: 0.0
variable_detected_material: "UNKNOWN"
variable_thermal_lag_samples: 0
variable_thermal_lag_sum: 0.0
variable_enabled: False
variable_accumulated_travel: 0.0
variable_corner_temp_before: 0.0
variable_corner_thermal_samples: 0
variable_corner_thermal_sum: 0.0
variable_last_corner_count: 0

gcode:
    # =========================================================
    #  READ CONFIGURATION FROM VARIABLES ABOVE
    # =========================================================
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set use_high_flow_nozzle = cfg.use_high_flow_nozzle %}
    
    {% set vars = printer.save_variables.variables %}
    {% set flow_smoothing = cfg.flow_smoothing %}
    # Per-material boost limits (set by AT_INIT_MATERIAL), fallback to config defaults
    {% set max_boost_limit = vars.material_max_boost|default(cfg.max_boost_limit)|float %}
    # Per-material ramp rates (set by AT_INIT_MATERIAL), fallback to config defaults
    {% set ramp_rate_rise = vars.material_ramp_rise|default(cfg.ramp_rate_rise)|float %}
    {% set ramp_rate_fall = vars.material_ramp_fall|default(cfg.ramp_rate_fall)|float %}
    {% set thermal_runaway_threshold = cfg.thermal_runaway_threshold %}
    {% set thermal_undertemp_threshold = cfg.thermal_undertemp_threshold %}

    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # Flow Gate - minimum flow (mm³/s) to trigger boost
    # Per-material value based on E3D Revo datasheet flow ratings
    # Fallback to nozzle-type defaults if not set
    {% if vars.material_flow_gate is defined %}
        {% set min_flow_mm3 = vars.material_flow_gate|float %}
    {% elif use_high_flow_nozzle %}
        {% set min_flow_mm3 = 12.0 %}
    {% else %}
        {% set min_flow_mm3 = 8.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: GET LOOKAHEAD DATA ---
        {% set predicted_rate = printer["extruder_monitor"].predicted_extrusion_rate|default(0.0)|float %}

        # --- B2: FIRST LAYER CHECK ---
        # Disable boost during first layer for consistent squish
        # Use Z height - most reliable method
        {% set first_layer_skip = cfg.first_layer_skip|default(True) %}
        {% set first_layer_h = cfg.first_layer_height|default(0.3)|float %}
        {% set on_first_layer = first_layer_skip and (current_z <= first_layer_h + 0.05) %}

        # --- C: CALCULATE BOOST (Velocity + Acceleration + Lookahead) ---
        
        # 1. Calculate Flow from live velocity
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        
        # 1b. Get toolhead linear speed (X/Y movement)
        {% set toolhead_speed = printer.motion_report.live_velocity|default(0)|float %}
        
        # 2. Smoothing
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}
        
        # 3. ACCELERATION KICK (Predictive Boost)
        {% set flow_accel = raw_vol_flow - last_vol_flow %}
        {% set accel_boost = 0.0 %}
        {% if flow_accel > 2.0 %}
            {% set accel_boost = flow_accel * 2.0 %}
        {% endif %}

        # 4. LOOKAHEAD BOOST (Predictive from upcoming G-code)
        # With 5s buffer, we can be more aggressive with pre-heating
        {% set predicted_vol_flow = predicted_rate * 2.405 %}
        {% set lookahead_boost = 0.0 %}
        {% if predicted_vol_flow > smooth_vol_flow %}
            {% set lookahead_delta = predicted_vol_flow - smooth_vol_flow %}
            {% set lookahead_boost = lookahead_delta * 0.8 %}
        {% endif %}

        # 5. Flow-Based Boost
        {% set flow_k = vars.material_flow_k|default(0.0)|float %}
        
        # 6. Speed-Based Boost (for high-speed thin walls)
        # Per-material speed_boost_k (set by AT_INIT_MATERIAL), fallback to config default
        {% set speed_threshold = cfg.speed_boost_threshold|default(100.0)|float %}
        {% set speed_k = vars.material_speed_boost_k|default(cfg.speed_boost_k)|float %}
        {% set linear_speed_boost = 0.0 %}
        {% if toolhead_speed > speed_threshold %}
            {% set linear_speed_boost = (toolhead_speed - speed_threshold) * speed_k %}
        {% endif %}
        
        # First Layer Mode - no boost on first layer
        {% if on_first_layer %}
            {% set flow_boost = 0.0 %}
            {% set linear_speed_boost = 0.0 %}
            {% set accel_boost = 0.0 %}
            {% set lookahead_boost = 0.0 %}
        # Gated Logic - only flow boost above minimum flow (speed boost always active)
        {% elif smooth_vol_flow < min_flow_mm3 %}
            {% set flow_boost = 0.0 %}
        {% else %}
            {% set flow_boost = smooth_vol_flow * flow_k %}
        {% endif %}

        # --- D: SMOOTHING & RAMPING ---
        
        # Total boost = flow boost + speed boost + acceleration kick + lookahead
        {% set raw_boost_target = flow_boost + linear_speed_boost + accel_boost + lookahead_boost %}
        
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        # Get last boost value for ramping
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        
        # --- D2: HEATER DUTY CYCLE CHECK ---
        # Don't request more heat if heater is already maxed out
        {% set heater_power = printer.extruder.power|default(0)|float %}
        
        {% if heater_power > 0.95 %}
            # Heater at 95%+ duty cycle - don't increase boost
            {% if raw_boost_target > last_boost %}
                {% set raw_boost_target = last_boost %}
            {% endif %}
            # Optionally reduce if heater saturated for multiple cycles
            {% if heater_power >= 0.99 %}
                {% set raw_boost_target = last_boost - ramp_rate_fall %}
                {% if raw_boost_target < 0 %} {% set raw_boost_target = 0 %} {% endif %}
            {% endif %}
        {% endif %}
        
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        # Linear Ramp Safety
        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}
        
        # --- E: APPLY TEMPERATURE ---
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}
        {% if new_target < saved_base %} {% set new_target = saved_base|int %} {% endif %}

        # Only update if temp changed by at least 1°C
        {% set temp_diff = (new_target - current_setpoint)|abs %}
        {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}

        # --- F: THERMAL SAFETY CHECK ---
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set target_temp = printer.extruder.target|float %}
        {% set temp_deviation = actual_temp - target_temp %}
        
        # Skip thermal checks if heater is off (target = 0)
        {% if target_temp > 0 %}
        
        # Check for thermal runaway (temp too high)
        {% if temp_deviation > thermal_runaway_threshold %}
            {% set fault_count = printer["gcode_macro _AUTO_TEMP_CORE"].thermal_fault_count + 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE={fault_count}
            
            {% if fault_count >= 3 %}
                # Multiple consecutive faults - emergency shutdown
                _AT_THERMAL_EMERGENCY reason="RUNAWAY" actual={actual_temp} target={target_temp}
            {% else %}
                # Single fault - reduce boost and warn
                RESPOND TYPE=error MSG="THERMAL WARNING: Temp {actual_temp}C exceeds target {target_temp}C by {temp_deviation|round(1)}C"
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
                M104 S{saved_base|int}  ; Drop to base temp immediately
            {% endif %}
        
        # Check for undertemp (heater not keeping up)
        {% elif temp_deviation < (0 - thermal_undertemp_threshold) %}
            RESPOND TYPE=echo MSG="THERMAL NOTICE: Temp {actual_temp}C is {(0-temp_deviation)|round(1)}C below target. Heater may be struggling."
            # Don't add more boost if heater can't keep up - reduce demand
            {% if smooth_boost > 10 %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost * 0.5}
            {% endif %}
        
        {% else %}
            # Temp is within safe range - reset fault counter
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
        {% endif %}
        
        {% endif %}  # End target_temp > 0 guard

        # --- G: SELF-LEARNING K-VALUE ADJUSTMENT ---
        # Monitors thermal response and adjusts K-values to optimize over time
        {% set self_learn = cfg.self_learning_enabled %}
        {% set learn_rate = cfg.learning_rate %}
        
        # Only learn when heater has headroom (< 90% PWM) - learning at 100% PWM gives bad data
        {% if self_learn and smooth_boost > 1.0 and heater_power < 0.90 %}
            # We're actively boosting - monitor how well temp follows
            {% set thermal_error = target_temp - actual_temp %}  # Positive = too cold
            
            # Only learn when we have significant demand
            {% if smooth_vol_flow > min_flow_mm3 %}
                {% set lag_samples = cfg.thermal_lag_samples %}
                {% set lag_sum = cfg.thermal_lag_sum %}
                
                # Track thermal error for learning
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE={lag_samples + 1}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE={lag_sum + thermal_error}
                
                # Every 50 samples, evaluate and potentially adjust
                {% if lag_samples > 0 and (lag_samples % 50) == 0 %}
                    {% set avg_error = lag_sum / lag_samples %}
                    
                    {% if avg_error > 3.0 %}
                        # Consistently too cold - heater can't keep up
                        # Increase speed_k to boost temp earlier
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k + learn_rate %}
                        {% if new_speed_k > 2.0 %}
                            {% set new_speed_k = 2.0 %}  # Cap at reasonable max
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg thermal lag {avg_error|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% elif avg_error < -3.0 %}
                        # Consistently too hot - reduce boost aggressiveness
                        {% set current_speed_k = vars.material_flow_k|default(0.5)|float %}
                        {% set new_speed_k = current_speed_k - learn_rate %}
                        {% if new_speed_k < 0.1 %}
                            {% set new_speed_k = 0.1 %}  # Don't go below minimum
                        {% endif %}
                        SAVE_VARIABLE VARIABLE=material_flow_k VALUE={new_speed_k|round(3)}
                        RESPOND MSG="SELF-LEARN: Avg overshoot {(0-avg_error)|round(1)}C, speed_k {current_speed_k|round(3)} -> {new_speed_k|round(3)}"
                    {% endif %}
                    
                    # Reset for next learning window
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
                {% endif %}
            {% endif %}
        {% endif %}

        # --- H: PA AUTO-LEARNING (Corner-Based) ---
        # Monitors thermal behavior after sharp corners to tune PA
        # Theory: Wrong PA causes over/under extrusion at corners which affects heater load
        {% set pa_learn = cfg.pa_auto_learning|default(False) %}
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        
        {% if pa_learn and base_pa > 0 %}
            {% set corner_count = printer["extruder_monitor"].corner_count_5s|default(0)|int %}
            {% set last_corner_count = cfg.last_corner_count %}
            
            # Detect when new corners have occurred
            {% if corner_count > last_corner_count %}
                {% set new_corners = corner_count - last_corner_count %}
                
                # Sample temperature deviation after corner
                # We're looking for thermal changes caused by PA mismatch
                {% set thermal_delta = actual_temp - target_temp %}
                
                # Accumulate samples
                {% set corner_samples = cfg.corner_thermal_samples + new_corners %}
                {% set corner_sum = cfg.corner_thermal_sum + (thermal_delta * new_corners) %}
                
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_samples VALUE={corner_samples}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_sum VALUE={corner_sum}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_corner_count VALUE={corner_count}
                
                # Every 30 corners, evaluate PA and potentially adjust
                {% if corner_samples >= 30 %}
                    {% set avg_corner_thermal = corner_sum / corner_samples %}
                    {% set pa_learn_rate = cfg.pa_learning_rate|default(0.002)|float %}
                    {% set current_pa = printer.extruder.pressure_advance|float %}
                    
                    # Thermal interpretation:
                    # - Positive (too hot after corners) = over-extrusion = too little PA
                    # - Negative (too cold after corners) = under-extrusion = too much PA
                    
                    {% if avg_corner_thermal > 1.5 %}
                        # Too hot at corners - increase PA to reduce bulging
                        {% set new_pa = base_pa + pa_learn_rate %}
                        {% if new_pa > 0.15 %}
                            {% set new_pa = 0.15 %}  # Cap at reasonable max
                        {% endif %}
                        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={new_pa}
                        RESPOND MSG="PA-LEARN: Corner overheat {avg_corner_thermal|round(2)}C, PA {base_pa|round(4)} -> {new_pa|round(4)}"
                    {% elif avg_corner_thermal < -1.5 %}
                        # Too cold at corners - decrease PA to reduce under-extrusion
                        {% set new_pa = base_pa - pa_learn_rate %}
                        {% if new_pa < 0.01 %}
                            {% set new_pa = 0.01 %}  # Don't go below minimum
                        {% endif %}
                        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={new_pa}
                        RESPOND MSG="PA-LEARN: Corner underheat {avg_corner_thermal|round(2)}C, PA {base_pa|round(4)} -> {new_pa|round(4)}"
                    {% endif %}
                    
                    # Reset for next learning window
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_samples VALUE=0
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_sum VALUE=0.0
                {% endif %}
            {% endif %}
        {% endif %}

        # Pressure Advance - apply dynamic compensation based on temp boost
        # Higher temps = lower viscosity = less PA needed
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if base_pa > 0 %}
            # Per-material PA scaling (set by AT_INIT_MATERIAL)
            {% set pa_k = vars.material_pa_boost_k|default(0.001)|float %}
            {% set pa_reduction = smooth_boost * pa_k %}
            {% set new_pa = base_pa - pa_reduction %}
            {% if new_pa < (base_pa * 0.5) %} {% set new_pa = base_pa * 0.5 %} {% endif %}
            {% if new_pa < 0.01 %} {% set new_pa = 0.01 %} {% endif %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.005 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
        # Log data point for session analysis
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set current_pa = printer.extruder.pressure_advance|float %}
        {% set predicted_flow = printer.extruder_monitor.predicted_extrusion_rate|default(0)|float * 2.405 %}
        AT_LOG_DATA TEMP={actual_temp} TARGET={new_target} BOOST={smooth_boost|round(1)} FLOW={vol_flow|round(2)} SPEED={live_speed|round(1)} PWM={heater_power|round(3)} PA={current_pa|round(4)} Z={current_z|round(2)} PREDICTED={predicted_flow|round(2)}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. THERMAL SAFETY
# =========================================================
# =========================================================
[gcode_macro _AT_THERMAL_EMERGENCY]
description: Emergency thermal shutdown - called when runaway detected
gcode:
    {% set reason = params.REASON|default("UNKNOWN")|string %}
    {% set actual = params.ACTUAL|default(0)|float %}
    {% set target = params.TARGET|default(0)|float %}
    
    # Immediately disable auto-temp
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    
    # Turn off heater (set to 0)
    M104 S0
    
    # Pause print
    PAUSE
    
    # Alert user
    RESPOND TYPE=error MSG="!!! THERMAL EMERGENCY !!!"
    RESPOND TYPE=error MSG="Reason: {reason}"
    RESPOND TYPE=error MSG="Actual: {actual}C | Target: {target}C"
    RESPOND TYPE=error MSG="Heater OFF - Print PAUSED - Auto-Temp DISABLED"
    RESPOND TYPE=error MSG="Check hotend and thermistor before resuming!"
    
    M117 THERMAL EMERGENCY - CHECK HOTEND!

[gcode_macro AT_THERMAL_STATUS]
description: Display current thermal safety status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set actual = printer.extruder.temperature|float %}
    {% set target = printer.extruder.target|float %}
    {% set base = vars.base_print_temp|default(0)|float %}
    {% set boost = cfg.current_boost %}
    {% set faults = cfg.thermal_fault_count %}
    
    {% set deviation = actual - target %}
    {% set runaway_limit = cfg.thermal_runaway_threshold %}
    {% set undertemp_limit = cfg.thermal_undertemp_threshold %}
    
    RESPOND MSG="===== THERMAL STATUS ====="
    RESPOND MSG="Actual: {actual|round(1)}C | Target: {target|round(1)}C"
    RESPOND MSG="Base: {base|round(1)}C | Boost: +{boost|round(1)}C"
    RESPOND MSG="Deviation: {deviation|round(1)}C"
    RESPOND MSG="Limits: Runaway +{runaway_limit}C | Undertemp -{undertemp_limit}C"
    RESPOND MSG="Fault Count: {faults}/3"
    {% if vars.at_enabled|default(False) %}
        RESPOND MSG="Status: ACTIVE"
    {% else %}
        RESPOND MSG="Status: DISABLED"
    {% endif %}
    RESPOND MSG="=========================="

[gcode_macro AT_STATUS]
description: Display full Adaptive Flow system status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    
    # System state
    {% set enabled = vars.at_enabled|default(False) %}
    {% set base_temp = vars.base_print_temp|default(0)|float %}
    {% set max_temp = vars.at_max_temp|default(300)|int %}
    {% set flow_k = vars.material_flow_k|default(0)|float %}
    
    # Current values from macro state
    {% set boost = cfg.current_boost %}
    {% set fault_count = cfg.thermal_fault_count %}
    
    # Configuration
    {% set use_hf = cfg.use_high_flow_nozzle %}
    
    # Thermal info
    {% set actual_temp = printer.extruder.temperature|float %}
    {% set target_temp = printer.extruder.target|float %}
    {% set current_pa = printer.extruder.pressure_advance|default(0)|float %}
    {% set base_pa = cfg.base_pa|default(0)|float %}
    
    # Flow and lookahead data
    {% set predicted = printer.extruder_monitor.predicted_extrusion_rate|default(0)|float %}
    {% set last_vol_flow = cfg.last_vol_flow|default(0)|float %}
    
    RESPOND MSG="╔═══════════════════════════════════════════╗"
    RESPOND MSG="║      ADAPTIVE FLOW STATUS                 ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    
    # System State
    {% if enabled %}
        RESPOND MSG="║ System: ✓ ENABLED                         ║"
    {% else %}
        RESPOND MSG="║ System: ✗ DISABLED                        ║"
    {% endif %}
    
    # Hotend Type
    {% if use_hf %}
        RESPOND MSG="║ Hotend: Revo HF (High Flow)               ║"
    {% else %}
        RESPOND MSG="║ Hotend: Revo Standard                     ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ TEMPERATURE                               ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Actual:    {"%6.1f"|format(actual_temp)}°C                        ║"
    RESPOND MSG="║ Target:    {"%6.1f"|format(target_temp)}°C                        ║"
    RESPOND MSG="║ Base:      {"%6.1f"|format(base_temp)}°C                        ║"
    RESPOND MSG="║ Boost:     {"%+6.1f"|format(boost)}°C                        ║"
    RESPOND MSG="║ Max Limit: {"%6d"|format(max_temp)}°C                        ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ PRESSURE ADVANCE                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Current PA: {"%6.3f"|format(current_pa)}                         ║"
    RESPOND MSG="║ Base PA:    {"%6.3f"|format(base_pa)}                         ║"
    {% set corner_samples = cfg.corner_thermal_samples|default(0)|int %}
    {% set corner_count = printer["extruder_monitor"].corner_count_5s|default(0)|int %}
    RESPOND MSG="║ Corners:   {"%6d"|format(corner_count)} (5s) / {"%d"|format(corner_samples)} samples      ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ FLOW & SPEED                              ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set flow_gate = vars.material_flow_gate|default(0)|float %}
    {% set toolhead_speed = printer.motion_report.live_velocity|default(0)|float %}
    {% set speed_threshold = cfg.speed_boost_threshold|default(100.0)|float %}
    RESPOND MSG="║ Flow K:      {"%6.2f"|format(flow_k)}                         ║"
    RESPOND MSG="║ Flow Gate:  {"%6.1f"|format(flow_gate)} mm³/s               ║"
    RESPOND MSG="║ Current Flow:{"%6.2f"|format(last_vol_flow)} mm³/s               ║"
    RESPOND MSG="║ Toolhead:   {"%6.1f"|format(toolhead_speed)} mm/s (>{speed_threshold|int})   ║"
    {% if predicted > 0 %}
        RESPOND MSG="║ Predicted:   {"%6.2f"|format(predicted)} mm/s                  ║"
    {% else %}
        RESPOND MSG="║ Predicted:   ------ (idle)                 ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SAFETY                                    ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set heater_power = printer.extruder.power|default(0)|float %}
    {% set power_pct = (heater_power * 100)|round(0)|int %}
    {% set current_z = printer.toolhead.position.z|float %}
    {% set first_layer_h = cfg.first_layer_height|default(0.3)|float %}
    {% set first_layer_skip = cfg.first_layer_skip|default(True) %}
    {% set on_first_layer = first_layer_skip and (current_z <= first_layer_h + 0.05) %}
    RESPOND MSG="║ Heater PWM:   {"%5d"|format(power_pct)}%                        ║"
    RESPOND MSG="║ Z Height:    {"%6.2f"|format(current_z)} mm                     ║"
    {% if on_first_layer %}
        RESPOND MSG="║ First Layer: YES (boost disabled)         ║"
    {% else %}
        RESPOND MSG="║ First Layer: NO                           ║"
    {% endif %}
    RESPOND MSG="║ Thermal Faults: {fault_count}/3                        ║"
    
    RESPOND MSG="╚═══════════════════════════════════════════╝"

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: State reset complete"

    
[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
description: Set the flow-based temperature boost coefficient
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={k}
    RESPOND MSG="Flow K set to {k}"

[gcode_macro AT_SET_FLOW_GATE]
description: Set the minimum flow rate (mm³/s) to trigger temperature boost
gcode:
    {% set gate = params.GATE|default(10)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_gate VALUE={gate}
    RESPOND MSG="Flow gate set to {gate} mm³/s"

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_INIT_MATERIAL]
description: Load material profile and apply settings
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Read hotend type from shared config variable in _AUTO_TEMP_CORE
    {% set use_hf = printer["gcode_macro _AUTO_TEMP_CORE"].use_high_flow_nozzle %}
    
    # =========================================================
    # LOAD PROFILE FROM material_profiles.cfg
    # Tries exact match first, then known mappings, then DEFAULT
    # =========================================================
    
    # Map material variants to base profiles
    {% set profile_name = "DEFAULT" %}
    {% if 'PLA' in material %}
        {% set profile_name = "PLA" %}
    {% elif 'PETG' in material or 'PET' in material %}
        {% set profile_name = "PETG" %}
    {% elif 'ASA' in material %}
        {% set profile_name = "ASA" %}
    {% elif 'ABS' in material %}
        {% set profile_name = "ABS" %}
    {% elif 'TPU' in material or 'TPE' in material or 'FLEX' in material %}
        {% set profile_name = "TPU" %}
    {% elif 'NYLON' in material or 'PA6' in material or 'PA12' in material %}
        {% set profile_name = "NYLON" %}
    {% elif 'PC' in material or 'POLYCARB' in material %}
        {% set profile_name = "PC" %}
    {% elif 'HIPS' in material %}
        {% set profile_name = "HIPS" %}
    {% endif %}
    
    # Try to load the profile macro
    {% set profile_macro = "_AF_PROFILE_" ~ profile_name %}
    {% set profile = printer["gcode_macro " ~ profile_macro]|default(none) %}
    
    # Fallback to DEFAULT if profile not found
    {% if profile is none %}
        {% set profile = printer["gcode_macro _AF_PROFILE_DEFAULT"] %}
        {% set profile_name = "DEFAULT" %}
    {% endif %}
    
    # Read values from profile
    {% set flow_k = profile.flow_k|default(0.5)|float %}
    {% set speed_boost_k = profile.speed_boost_k|default(0.06)|float %}
    {% set max_boost = profile.max_boost|default(35.0)|float %}
    {% set max_temp_safety = profile.max_temp|default(280)|int %}
    {% set pa_boost_k = profile.pa_boost_k|default(0.001)|float %}
    {% set ramp_rise = profile.ramp_rise|default(4.0)|float %}
    {% set ramp_fall = profile.ramp_fall|default(1.5)|float %}
    {% set default_pa = profile.default_pa|default(0.040)|float %}
    
    # Select flow gate based on nozzle type
    {% if use_hf %}
        {% set flow_gate = profile.flow_gate|default(10.0)|float %}
    {% else %}
        {% set flow_gate = profile.flow_gate_std|default(8.0)|float %}
    {% endif %}
    
    # =========================================================
    # GET PA: User-calibrated value OR profile default
    # =========================================================
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_")|replace("-", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    {% if saved_pa >= 0 %}
        {% set pa_val = saved_pa %}
        {% set pa_source = "calibrated" %}
    {% else %}
        {% set pa_val = default_pa %}
        {% set pa_source = "default" %}
    {% endif %}

    # --- APPLY ---
    # Save all per-material boost curve parameters
    SAVE_VARIABLE VARIABLE=material_ramp_rise VALUE={ramp_rise}
    SAVE_VARIABLE VARIABLE=material_ramp_fall VALUE={ramp_fall}
    SAVE_VARIABLE VARIABLE=material_speed_boost_k VALUE={speed_boost_k}
    SAVE_VARIABLE VARIABLE=material_max_boost VALUE={max_boost}
    SAVE_VARIABLE VARIABLE=material_pa_boost_k VALUE={pa_boost_k}
    
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={pa_val}
        RESPOND MSG="PA: {pa_val} ({pa_source})"
    {% endif %}

    {% if flow_k > 0 %}
        AT_SET_FLOW_K K={flow_k}
        AT_SET_FLOW_GATE GATE={flow_gate}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material} -> {profile_name} profile)"
        RESPOND MSG="  Flow K={flow_k}, Speed K={speed_boost_k}, Max Boost={max_boost}C"
        RESPOND MSG="  Ramp: +{ramp_rise}/-{ramp_fall} C/s, Flow gate={flow_gate}mm3/s"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"  
    {% endif %}

# =========================================================
#  PA CALIBRATION MACROS
# =========================================================
[gcode_macro AT_SET_PA]
description: Save calibrated PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper|replace(" ", "_") %}
    {% set pa = params.PA|default(0.04)|float %}
    
    {% if pa < 0 or pa > 1.0 %}
        RESPOND TYPE=error MSG="PA value must be between 0 and 1.0"
    {% else %}
        SAVE_VARIABLE VARIABLE=pa_{material|lower} VALUE={pa}
        RESPOND MSG="Saved PA for {material}: {pa}"
        RESPOND MSG="This will be used next time you run AT_INIT_MATERIAL MATERIAL={material}"
    {% endif %}

[gcode_macro AT_GET_PA]
description: Show saved or default PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    RESPOND MSG="===== PA for {material} ====="
    {% if saved_pa >= 0 %}
        RESPOND MSG="Saved (calibrated): {saved_pa}"
    {% else %}
        RESPOND MSG="Saved: None (not calibrated)"
    {% endif %}
    
    {% set def_val = default_pa[material]|default(0)|float %}
    {% if def_val > 0 %}
        RESPOND MSG="Default: {def_val}"
    {% else %}
        RESPOND MSG="Default: None (unknown material)"
    {% endif %}
    
    {% if saved_pa >= 0 %}
        RESPOND MSG="Will use: {saved_pa} (calibrated)"
    {% elif def_val > 0 %}
        RESPOND MSG="Will use: {def_val} (default)"
    {% else %}
        RESPOND MSG="Will use: 0 (no PA)"
    {% endif %}

[gcode_macro AT_LIST_PA]
description: List all saved PA values and defaults
gcode:
    {% set vars = printer.save_variables.variables %}
    
    # Default PA values
    {% set default_pa = {
        'PLA': 0.040,
        'PETG': 0.060,
        'ABS': 0.050,
        'ASA': 0.050,
        'TPU': 0.200,
        'NYLON': 0.055,
        'PC': 0.045,
        'HIPS': 0.045
    } %}
    
    RESPOND MSG="===== PRESSURE ADVANCE VALUES ====="
    RESPOND MSG="Material | Saved | Default"
    RESPOND MSG="---------|-------|--------"
    {% for mat, def_pa in default_pa.items() %}
        {% set saved = vars["pa_" ~ mat|lower]|default(-1)|float %}
        {% if saved >= 0 %}
            RESPOND MSG="{mat}: {saved} (calibrated) | {def_pa}"
        {% else %}
            RESPOND MSG="{mat}: - | {def_pa}"
        {% endif %}
    {% endfor %}
    RESPOND MSG="===================================="
    RESPOND MSG="To calibrate: AT_SET_PA MATERIAL=<name> PA=<value>"
# =========================================================================
# ZERO-CONFIG ENTRY POINT
# =========================================================================
# AT_START: The ONLY macro you need in your slicer's start g-code!
#
# RECOMMENDED: Pass material from slicer for accurate profile selection:
#   OrcaSlicer/PrusaSlicer: AT_START MATERIAL={filament_type[0]}
#   Cura:                   AT_START MATERIAL={material_type}
#   SuperSlicer:            AT_START MATERIAL={filament_type[0]}
#
# If no material is passed, falls back to temperature-based detection.
# =========================================================================

[gcode_macro AT_START]
description: Start adaptive temperature - pass MATERIAL from slicer for best results
gcode:
    # Get material from slicer parameter (preferred) or detect from temp
    {% set slicer_material = params.MATERIAL|default("")|string|upper|replace(" ", "")|replace("-", "") %}
    {% set target_temp = printer.extruder.target|default(0)|int %}
    {% set vars = printer.save_variables.variables %}
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    
    # Warn if no temperature set (AT_START called before heating commands)
    {% if target_temp < 150 %}
        RESPOND TYPE=echo MSG="AT_START: Warning - extruder target is {target_temp}C. Call AT_START AFTER your heating commands (M104/M109)."
        {% set target_temp = 200 %}
    {% endif %}
    
    # Normalize common material name variations
    {% set material = "PLA" %}  # Default fallback
    
    {% if slicer_material != "" %}
        # Material explicitly passed from slicer - use it!
        # Normalize variations: "PLA+", "PLA-CF", "PETG-GF" etc.
        {% if "PLA" in slicer_material %}
            {% set material = "PLA" %}
        {% elif "PETG" in slicer_material or "PET" in slicer_material %}
            {% set material = "PETG" %}
        {% elif "ABS" in slicer_material %}
            {% set material = "ABS" %}
        {% elif "ASA" in slicer_material %}
            {% set material = "ASA" %}
        {% elif "TPU" in slicer_material or "TPE" in slicer_material or "FLEX" in slicer_material %}
            {% set material = "TPU" %}
        {% elif "NYLON" in slicer_material or "PA" in slicer_material %}
            {% set material = "NYLON" %}
        {% elif "PC" in slicer_material or "POLYCARB" in slicer_material %}
            {% set material = "PC" %}
        {% elif "HIPS" in slicer_material %}
            {% set material = "HIPS" %}
        {% else %}
            # Unknown material - use as-is, AT_INIT_MATERIAL will handle defaults
            {% set material = slicer_material %}
        {% endif %}
        RESPOND MSG="AT_START: Material '{material}' from slicer ({slicer_material})"
    {% else %}
        # No material passed - fall back to temperature detection
        {% if target_temp >= 280 %}
            {% set material = "PC" %}
        {% elif target_temp >= 260 %}
            {% set material = "NYLON" %}
        {% elif target_temp >= 240 %}
            {% set material = "ABS" %}
        {% elif target_temp >= 220 %}
            {% set material = "PETG" %}
        {% elif target_temp >= 180 %}
            {% set material = "PLA" %}
        {% elif target_temp >= 160 %}
            {% set material = "TPU" %}
        {% endif %}
        RESPOND TYPE=echo MSG="AT_START: No MATERIAL param - detected '{material}' from temp {target_temp}C"
        RESPOND TYPE=echo MSG="TIP: Add MATERIAL={{filament_type[0]}} for accurate detection"
    {% endif %}
    
    # Store detected material
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=detected_material VALUE="'{material}'"
    
    # Initialize material settings (K-values, PA, safety limits)
    AT_INIT_MATERIAL MATERIAL={material}
    
    # Enable adaptive flow
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=True
    
    # Start logging session
    {% set print_file = printer.print_stats.filename|default("unknown") %}
    AT_LOG_START MATERIAL={material} FILE="{print_file}"
    
    RESPOND MSG="AT_START: Adaptive Temperature enabled for {material}"

[gcode_macro AT_END]
description: Clean shutdown of adaptive temperature at print end
gcode:
    # Stop the loop immediately
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=enabled VALUE=False
    
    # End logging session
    AT_LOG_END
    
    # Report any learned values if self-learning was active
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set lag_samples = cfg.thermal_lag_samples %}
    
    {% if lag_samples > 0 %}
        {% set avg_lag = cfg.thermal_lag_sum / lag_samples %}
        RESPOND MSG="AT_END: Avg thermal error: {avg_lag|round(2)}C over {lag_samples} samples (negative=overshoot)"
    {% endif %}
    
    # Report PA learning results
    {% set corner_samples = cfg.corner_thermal_samples %}
    {% set base_pa = cfg.base_pa %}
    {% if corner_samples > 0 %}
        {% set avg_corner = cfg.corner_thermal_sum / corner_samples %}
        RESPOND MSG="AT_END: PA learning - {corner_samples} corners, avg thermal delta: {avg_corner|round(2)}C"
        RESPOND MSG="AT_END: Final base PA: {base_pa|round(4)}"
        # Save the learned PA value for the material
        {% set material = cfg.detected_material %}
        {% if base_pa > 0 and material != "UNKNOWN" %}
            SAVE_VARIABLE VARIABLE=pa_{material|lower} VALUE={base_pa|round(4)}
            RESPOND MSG="AT_END: Saved PA {base_pa|round(4)} for {material}"
        {% endif %}
    {% endif %}
    
    # Reset per-print state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_samples VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_lag_sum VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_samples VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=corner_thermal_sum VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_corner_count VALUE=0
    
    RESPOND MSG="AT_END: Adaptive Temperature disabled"