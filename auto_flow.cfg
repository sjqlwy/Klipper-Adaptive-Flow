[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Blob Detect | Dynamic PA | Z-Watcher
variable_current_boost: 0.0
variable_last_load_val: 0
variable_layer_crash_count: 0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_slowdown_layers_left: 0
variable_slowdown_active: False
# Track previous flow for smoothing
variable_last_vol_flow: 0.0 

gcode:
    # =========================================================
    #  USER CONFIGURATION
    # =========================================================
    
    # 1. Hotend Type (Determines when boost kicks in)
    # True  = Revo High Flow (Boost starts > 15mm3/s)
    # False = Standard Revo    (Boost starts > 8mm3/s)
    {% set use_high_flow_nozzle = True %}

    # 2. Motor Sensor Calibration
    # Run AT_CHECK_BASELINE to find this number.
    # LDO Pancake: ~16 | Standard Nema 17: ~60+
    {% set sensor_baseline = 16 %} 
    
    # 3. Sensitivity Settings
    # Noise Filter (2 for Pancake, 10 for Nema17)
    {% set noise_filter = 2 %}
    
    # Crash Threshold (10 for Pancake, 20 for Nema17)
    {% set crash_threshold = 10 %}
    
    # 4. Advanced Tuning
    # Burst Protection (0.5 = Balanced). Smooths out short spikes.
    {% set flow_smoothing = 0.5 %}
    
    # Safety Limits
    {% set max_boost_limit = 50.0 %}
    {% set ramp_rate_rise = 2.0 %} 
    {% set ramp_rate_fall = 0.2 %}

    # =========================================================
    #  END CONFIGURATION - LOGIC BELOW
    # =========================================================

    {% set vars = printer.save_variables.variables %}
    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # --- AUTO-CALCULATE FLOW GATE ---
    {% if use_high_flow_nozzle %}
        {% set min_flow_mm3 = 15.0 %}
    {% else %}
        {% set min_flow_mm3 = 8.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            _AT_EVALUATE_LAYER
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: BLOB DETECTION ---
        {% set load_val = printer["extruder_monitor"].load|default(0)|int %}
        {% set last_load = printer["gcode_macro _AUTO_TEMP_CORE"].last_load_val %}
        {% set load_delta = (last_load - load_val)|abs %}

        {% if filament_speed > 2.0 and load_delta > crash_threshold %}
            {% set current_crashes = printer["gcode_macro _AUTO_TEMP_CORE"].layer_crash_count %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE={current_crashes + 1}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_load_val VALUE={load_val}

        # --- C: CALCULATE BOOST (Burst Protected) ---
        
        # 1. Calculate & Smooth Flow
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}

        # 2. Calculate Speed Boost
        {% set speed_k = vars.material_flow_k|default(0.0)|float %}
        
        # GATE LOGIC (Uses the Auto-Calculated min_flow_mm3)
        {% if smooth_vol_flow < min_flow_mm3 %}
            {% set speed_boost = 0.0 %}
        {% else %}
            {% set speed_boost = smooth_vol_flow * speed_k %}
        {% endif %}

        # 3. Strain Boost
        {% set board_temp = 35.0 %}
        {% if 'temperature_sensor Toolhead_Temp' in printer %}
            {% set board_temp = printer['temperature_sensor Toolhead_Temp'].temperature|float %}
        {% elif 'temperature_sensor mcu_temp' in printer %}
             {% set board_temp = printer['temperature_sensor mcu_temp'].temperature|float %}
        {% endif %}

        {% set corrected_load = load_val + ((board_temp - 35.0) * 0.4) %}
        {% if corrected_load < 0 %} {% set corrected_load = 0 %} {% endif %}
        {% set strain = sensor_baseline - corrected_load %}
        {% if strain < noise_filter %} {% set strain = 0 %} {% endif %}
        {% set load_boost = strain * vars.material_viscosity_k|default(0.0)|float %}

        # --- D: SMOOTHING & RAMPING ---
        {% set raw_boost_target = speed_boost + load_boost %}
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}
        
        # --- E: APPLY ---
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}

        {% if load_val != -1 %}
            {% set temp_diff = (new_target - current_setpoint)|abs %}
            {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}
        {% endif %}

        # Pressure Advance
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if base_pa > 0 %}
            {% set pa_multiplier = 1.0 - (smooth_boost * 0.01) %}
            {% if pa_multiplier < 0.5 %} {% set pa_multiplier = 0.5 %} {% endif %}
            {% set new_pa = base_pa * pa_multiplier %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.01 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. EVALUATION LOGIC
# =========================================================
[gcode_macro _AT_EVALUATE_LAYER]
description: Internal - Decides if the last layer was bad
gcode:
    {% set macro_vars = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set crashes = macro_vars.layer_crash_count %}
    {% set CRASH_LIMIT = 3 %} 
    
    {% if crashes > CRASH_LIMIT %}
        RESPOND TYPE=error MSG="Auto-Temp: Surface Defects Detected ({crashes} spikes). Slowing down."
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=3
        
        {% if not macro_vars.slowdown_active %}
            M220 S50 ; Drop to 50% Speed
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=True
        {% endif %}
        
    {% else %}
        {% if macro_vars.slowdown_layers_left > 0 %}
            {% set remaining = macro_vars.slowdown_layers_left - 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE={remaining}
            
            {% if remaining == 0 %}
                RESPOND MSG="Auto-Temp: Stability restored. Resuming 100% speed."
                M220 S100
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
            {% endif %}
        {% endif %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=layer_crash_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=slowdown_layers_left VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    M220 S100

[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_VISC_K]
gcode:
    SAVE_VARIABLE VARIABLE=material_viscosity_k VALUE={params.K|default(0)|float}

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_CHECK_BASELINE]
gcode:
    {% set temp = params.TEMP|default(220)|int %}
    M117 Heating to {temp}C...
    M109 S{temp}
    M117 Extruding FAST (50mm/s)...
    G91
    G1 E100 F3000 
    G90
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    G4 P500
    GET_EXTRUDER_LOAD
    M117 Done.


[gcode_macro AT_INIT_MATERIAL]
description: logic to set K-values and PA based on material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string %}
    
    # Defaults
    {% set load_k = 0.0 %}
    {% set speed_k = 0.0 %}
    {% set pa_val = 0.0 %}
    {% set max_temp_safety = 300 %}

    # --- MATERIAL DATABASE ---
    {% if 'PLA' in material %}
        # High Speed Revo PLA
        {% set load_k = 0.60 %}
        {% set speed_k = 1.40 %}
        {% set pa_val = 0.040 %}
        {% set max_temp_safety = 240 %}
        
    {% elif 'PETG' in material %}
        # High Speed Revo PETG
        {% set load_k = 0.80 %}
        {% set speed_k = 1.20 %}
        {% set pa_val = 0.060 %}
        {% set max_temp_safety = 280 %}
        
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set load_k = 0.20 %}
        {% set speed_k = 0.80 %}
        {% set pa_val = 0.050 %}
        {% set max_temp_safety = 290 %}
        
    {% elif 'TPU' in material %}
        # Disabled for TPU
        {% set pa_val = 0.20 %} 
        {% set max_temp_safety = 240 %}
    {% endif %}

    # --- APPLY SETTINGS ---
    
    # 1. Set Pressure Advance
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
    {% endif %}

    # 2. Enable Auto-Flow
    {% if load_k > 0 or speed_k > 0 %}
        AT_SET_VISC_K K={load_k}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material})"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"
    {% endif %}
