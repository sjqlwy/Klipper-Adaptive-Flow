[save_variables]
filename: ~/printer_data/config/sfs_auto_flow_vars.cfg

# Include material profiles (user-editable)
[include material_profiles.cfg]

# =========================================================
#  1. THE CORE LOGIC LOOP
# =========================================================
[gcode_macro _AUTO_TEMP_CORE]
description: Auto-Temp | Dynamic PA | Smart Cooling | DynZ Stress Relief
# =========================================================
#  USER CONFIGURATION (edit these variables)
#  NOTE: This script is designed for E3D Revo hotends only
# =========================================================
#
# HOTEND TYPE (Revo Only)
# -----------------------
# Set to True for Revo HF (High Flow) nozzles
# Set to False for Revo Standard nozzles
# This affects the flow gate threshold:
#   - Revo HF: enables boost only above 12mm³/s (matches HF flow capacity)
#   - Revo Std: enables boost above 8mm³/s (matches standard flow capacity)
variable_use_high_flow_nozzle: True
#
# SENSOR BASELINE (StallGuard calibration)
# ----------------------------------------
# This system uses G-code lookahead and live velocity data only.
# No TMC StallGuard / extruder load sensor required.
#
# ADVANCED TUNING
# ---------------
# flow_smoothing: Exponential smoothing factor for volumetric flow (0.0-1.0)
#   - Higher = more smoothing, slower response, less jitter
#   - Lower = faster response, may oscillate on variable flow
#   - 0.15 is responsive for speed changes, 0.3 for stability
variable_flow_smoothing: 0.15
#
# max_boost_limit: Maximum temperature boost above base temp (°C)
#   - Safety cap to prevent runaway heating
#   - 50°C allows base 200 to reach 250 max
variable_max_boost_limit: 50.0
#
# ramp_rate_rise: Max temp increase per loop cycle (°C/second)
#   - Higher = faster response to increased flow demand
#   - Too high may overshoot on brief speed bursts
#   - 4.0 is aggressive for fast infill, 2.0 is conservative
variable_ramp_rate_rise: 4.0
#
# ramp_rate_fall: Max temp decrease per loop cycle (°C/second)
#   - Lower = slower cooldown, maintains heat during brief pauses
#   - Higher = faster return to base temp, reduces corner bulge
#   - Keep lower than rise rate for stability
variable_ramp_rate_fall: 1.0
#
# SPEED-BASED BOOST
# -----------------
# High linear speeds need heat even with low volumetric flow (thin walls)
# speed_boost_threshold: Linear speed (mm/s) above which speed boost activates
variable_speed_boost_threshold: 100.0
#
# speed_boost_k: Temperature boost per mm/s above threshold
#   - At 200mm/s with threshold 100 and k=0.08: (200-100)*0.08 = 8°C boost
#   - At 300mm/s with threshold 100 and k=0.08: (300-100)*0.08 = 16°C boost
variable_speed_boost_k: 0.08
#
# THERMAL SAFETY
# --------------
# thermal_runaway_threshold: Max deviation from target before emergency stop (°C)
#   - If actual temp exceeds target + this value, system triggers emergency
#   - Set based on your hotend's thermal characteristics
#   - 15°C is conservative, increase for hotends with slow response
variable_thermal_runaway_threshold: 15.0
#
# thermal_undertemp_threshold: Min temp below target before warning (°C)
#   - If actual temp drops below target - this value during active printing,
#     the system will reduce boost and warn
#   - Helps detect heater issues or cooling problems
variable_thermal_undertemp_threshold: 10.0
#
# FIRST LAYER MODE
# -----------------
# Automatically disables boost on layer 1 for consistent squish
# Uses slicer layer info if available, falls back to Z height
# Set to False to allow boost on first layer
variable_first_layer_skip: True
#
# first_layer_height: Fallback if slicer doesn't send layer info (mm)
#   - Used when print_stats.info.current_layer is not available
variable_first_layer_height: 0.3
#
# DYNAMIC PRESSURE ADVANCE
# ------------------------
# Adjusts PA dynamically based on flow rate for better corner quality
variable_pa_enable: True
#
# MULTI-OBJECT TEMPERATURE MANAGEMENT
# -----------------------------------
# Automatically wait for temperature stabilization between objects
# to prevent thermal runaway when printing multiple objects sequentially
variable_multi_object_temp_wait: True
#
# temp_wait_tolerance: Maximum temperature difference (°C) to ignore
#   - If current temp is within this range of target, no wait occurs
#   - Prevents unnecessary pauses for small temperature differences
#   - Set to 0 to always wait for exact target temperature
variable_temp_wait_tolerance: 5.0
#
# temp_wait_timeout: Maximum time to wait for temperature (seconds)
#   - Note: This is currently informational only
#   - TEMPERATURE_WAIT will wait until temperature is reached
#   - This is safer as it prevents printing at wrong temperatures
variable_temp_wait_timeout: 300
#
# =========================================================
variable_current_boost: 0.0
variable_last_stable_z: 0.0
variable_base_pa: 0.0
variable_last_vol_flow: 0.0
variable_thermal_fault_count: 0
variable_detected_material: "UNKNOWN"

# =========================================================
# DYNAMIC Z-WINDOW LEARNING (CONVEX STRESS DETECTION)
# =========================================================

# Enable dynamic learning
variable_dynz_enable: True

# Z bin size in mm (1.0 = very stable, 0.5 = more sensitive)
variable_dynz_bin_height: 1.0

# Stress detection thresholds
variable_dynz_speed_thresh: 80.0       # mm/s
variable_dynz_flow_max: 8.0             # mm³/s
variable_dynz_pwm_thresh: 0.70           # heater duty fraction

# Learning parameters
variable_dynz_score_inc: 1.0             # score added per stress hit
variable_dynz_score_decay: 0.90           # decay when no stress
variable_dynz_activate_score: 4.0         # score to activate relief
variable_dynz_deactivate_score: 1.5       # score to deactivate

# Acceleration limits
variable_dynz_base_accel: 0
variable_dynz_accel_relief: 3200          # mm/s² during stress

# Internal state (DO NOT EDIT)
variable_dynz_active: False
variable_dynz_last_bin: -1

# =========================================================
# SMART COOLING (FLOW-BASED FAN CONTROL)
# =========================================================
#   Adjusts part cooling fan based on flow rate and layer time.
#   High flow = less cooling needed (fast moves provide airflow)
#   Short layers = more cooling needed (prevent heat buildup)
#
# Enable/disable smart cooling
variable_sc_enable: True

# Base fan speed (0-255, set by slicer or PRINT_START)
# If 0, uses current M106 value as base
variable_sc_base_fan: 255

# Flow threshold where cooling reduction starts (mm³/s)
# Below this, fan runs at base speed
variable_sc_flow_gate: 8.0

# Fan reduction per mm³/s above flow_gate (0-1 scale)
# E.g., 0.03 = 3% reduction per mm³/s extra flow
variable_sc_flow_k: 0.03

# Layer time boost: increase fan if layer is fast
# Threshold in seconds - layers faster than this get extra cooling
variable_sc_short_layer_time: 15.0

# Extra fan % per second below threshold (0-1 scale)
variable_sc_layer_time_k: 0.02

# Min/max fan limits (0.0-1.0 = 0-100%)
variable_sc_min_fan: 0.20
variable_sc_max_fan: 1.00

# First layer override - usually 0 for bed adhesion
variable_sc_first_layer_fan: 0.0

# Internal state (DO NOT EDIT)
variable_sc_last_z: 0.0
variable_sc_last_z_time: 0.0
variable_sc_layer_time: 999.0

gcode:
    # =========================================================
    #  READ CONFIGURATION FROM VARIABLES ABOVE
    # =========================================================
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set use_high_flow_nozzle = cfg.use_high_flow_nozzle %}
    
    {% set vars = printer.save_variables.variables %}
    {% set flow_smoothing = cfg.flow_smoothing %}
    # Per-material boost limits (set by AT_INIT_MATERIAL), fallback to config defaults
    {% set max_boost_limit = vars.material_max_boost|default(cfg.max_boost_limit)|float %}
    # Per-material ramp rates (set by AT_INIT_MATERIAL), fallback to config defaults
    {% set ramp_rate_rise = vars.material_ramp_rise|default(cfg.ramp_rate_rise)|float %}
    {% set ramp_rate_fall = vars.material_ramp_fall|default(cfg.ramp_rate_fall)|float %}
    {% set thermal_runaway_threshold = cfg.thermal_runaway_threshold %}
    {% set thermal_undertemp_threshold = cfg.thermal_undertemp_threshold %}

    {% set current_setpoint = printer.extruder.target|float %}
    {% set saved_base = vars.base_print_temp|default(0)|float %}
    
    # Flow Gate - minimum flow (mm³/s) to trigger boost
    # Per-material value based on E3D Revo datasheet flow ratings
    # Fallback to nozzle-type defaults if not set
    {% if vars.material_flow_gate is defined %}
        {% set min_flow_mm3 = vars.material_flow_gate|float %}
    {% elif use_high_flow_nozzle %}
        {% set min_flow_mm3 = 12.0 %}
    {% else %}
        {% set min_flow_mm3 = 8.0 %}
    {% endif %}
    
    {% if saved_base >= 170 and vars.at_enabled|default(False) %}
    
        # --- A: LAYER WATCHER ---
        {% set current_z = printer.toolhead.position.z|float %}
        {% set filament_speed = printer.motion_report.live_extruder_velocity|float %}
        {% set last_z = printer["gcode_macro _AUTO_TEMP_CORE"].last_stable_z %}
        
        {% if current_z > (last_z + 0.05) and filament_speed > 0 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE={current_z}
        {% endif %}

        # --- B: GET LOOKAHEAD DATA ---
        {% set predicted_rate = printer["extruder_monitor"].predicted_extrusion_rate|default(0.0)|float if "extruder_monitor" in printer else 0.0 %}

        # --- B2: FIRST LAYER CHECK ---
        # Disable boost during first layer for consistent squish
        # Use Z height - most reliable method
        {% set first_layer_skip = cfg.first_layer_skip|default(True) %}
        {% set first_layer_h = cfg.first_layer_height|default(0.3)|float %}
        {% set on_first_layer = first_layer_skip and (current_z <= first_layer_h + 0.05) %}

        # --- C: CALCULATE BOOST (Velocity + Acceleration + Lookahead) ---
        
        # 1. Calculate Flow from live velocity
        {% set raw_vol_flow = filament_speed * 2.405 %} 
        {% set last_vol_flow = printer["gcode_macro _AUTO_TEMP_CORE"].last_vol_flow %}
        
        # 1b. Get toolhead linear speed (X/Y movement)
        {% set toolhead_speed = printer.motion_report.live_velocity|default(0)|float %}
        
        # 2. Smoothing
        {% set smooth_vol_flow = (last_vol_flow * flow_smoothing) + (raw_vol_flow * (1.0 - flow_smoothing)) %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE={smooth_vol_flow}
        
        # 3. ACCELERATION KICK (Predictive Boost)
        {% set flow_accel = raw_vol_flow - last_vol_flow %}
        {% set accel_boost = 0.0 %}
        {% if flow_accel > 2.0 %}
            {% set accel_boost = flow_accel * 2.0 %}
        {% endif %}

        # 4. LOOKAHEAD BOOST (Predictive from upcoming G-code)
        # With 5s buffer, we can be more aggressive with pre-heating
        {% set predicted_vol_flow = predicted_rate * 2.405 %}
        {% set lookahead_boost = 0.0 %}
        {% if predicted_vol_flow > smooth_vol_flow %}
            {% set lookahead_delta = predicted_vol_flow - smooth_vol_flow %}
            {% set lookahead_boost = lookahead_delta * 0.8 %}
        {% endif %}

        # 5. Flow-Based Boost
        {% set flow_k = vars.material_flow_k|default(0.0)|float %}
        
        # 6. Speed-Based Boost (for high-speed thin walls)
        # Per-material speed_boost_k (set by AT_INIT_MATERIAL), fallback to config default
        {% set speed_threshold = cfg.speed_boost_threshold|default(100.0)|float %}
        {% set speed_k = vars.material_speed_boost_k|default(cfg.speed_boost_k)|float %}
        {% set linear_speed_boost = 0.0 %}
        {% if toolhead_speed > speed_threshold %}
            {% set linear_speed_boost = (toolhead_speed - speed_threshold) * speed_k %}
        {% endif %}
        
        # First Layer Mode - no boost on first layer
        {% if on_first_layer %}
            {% set flow_boost = 0.0 %}
            {% set linear_speed_boost = 0.0 %}
            {% set accel_boost = 0.0 %}
            {% set lookahead_boost = 0.0 %}
        # Gated Logic - only flow boost above minimum flow (speed boost always active)
        {% elif smooth_vol_flow < min_flow_mm3 %}
            {% set flow_boost = 0.0 %}
        {% else %}
            {% set flow_boost = smooth_vol_flow * flow_k %}
        {% endif %}

        # --- D: SMOOTHING & RAMPING ---
        
        # Total boost = flow boost + speed boost + acceleration kick + lookahead
        {% set raw_boost_target = flow_boost + linear_speed_boost + accel_boost + lookahead_boost %}
        
        {% if raw_boost_target > max_boost_limit %} {% set raw_boost_target = max_boost_limit %} {% endif %}
        
        # Get last boost value for ramping
        {% set last_boost = printer["gcode_macro _AUTO_TEMP_CORE"].current_boost %}
        
        # --- D2: HEATER DUTY CYCLE CHECK ---
        # Don't request more heat if heater is already maxed out
        {% set heater_power = printer.extruder.power|default(0)|float %}
        
        {% if heater_power > 0.95 %}
            # Heater at 95%+ duty cycle - don't increase boost
            {% if raw_boost_target > last_boost %}
                {% set raw_boost_target = last_boost %}
            {% endif %}
            # Optionally reduce if heater saturated for multiple cycles
            {% if heater_power >= 0.99 %}
                {% set raw_boost_target = last_boost - ramp_rate_fall %}
                {% if raw_boost_target < 0 %} {% set raw_boost_target = 0 %} {% endif %}
            {% endif %}
        {% endif %}
        
        {% set smooth_boost = last_boost %}
        {% set diff = raw_boost_target - last_boost %}

        # Linear Ramp Safety
        {% if diff > ramp_rate_rise %}
            {% set smooth_boost = last_boost + ramp_rate_rise %}
        {% elif diff < (0 - ramp_rate_fall) %}
            {% set smooth_boost = last_boost - ramp_rate_fall %}
        {% else %}
            {% set smooth_boost = raw_boost_target %}
        {% endif %}
        
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost}

        # =========================================================
        # --- H2: DYNAMIC Z-WINDOW LEARNING (CONVEX STRESS) ---
        # =========================================================
        
        {% if cfg.dynz_enable %}
        
            {% set bin_h = cfg.dynz_bin_height|float %}
            {% if bin_h < 0.1 %}{% set bin_h = 1.0 %}{% endif %}
            {% set z_bin = (current_z / bin_h)|int %}
            {% set vars = printer.save_variables.variables %}
        
            # Load previous score for this Z bin
            {% set bin_key = "dynz_bin_" ~ z_bin %}
            {% set bin_score = vars[bin_key]|default(0.0)|float %}
        
            # Stress condition detection
            {% set stress_speed = toolhead_speed >= cfg.dynz_speed_thresh %}
            {% set stress_flow = smooth_vol_flow <= cfg.dynz_flow_max %}
            {% set stress_pwm = heater_power >= cfg.dynz_pwm_thresh %}
        
            {% set stress_detected = stress_speed and stress_flow and stress_pwm %}
        
            # Update score
            {% if stress_detected %}
                {% set bin_score = bin_score + cfg.dynz_score_inc %}
            {% else %}
                {% set bin_score = bin_score * cfg.dynz_score_decay %}
            {% endif %}
        
            # Persist updated score
            SAVE_VARIABLE VARIABLE={bin_key} VALUE={bin_score}
        
            # Determine accel relief state
            {% set dynz_active = printer["gcode_macro _AUTO_TEMP_CORE"].dynz_active %}
        
            {% if bin_score >= cfg.dynz_activate_score and not dynz_active %}
                {% if cfg.dynz_base_accel <= 0 %}
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_base_accel VALUE={printer.toolhead.max_accel}
                {% endif %}
                SET_VELOCITY_LIMIT ACCEL={cfg.dynz_accel_relief}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_active VALUE=True

            {% elif bin_score <= cfg.dynz_deactivate_score and dynz_active %}
                SET_VELOCITY_LIMIT ACCEL={cfg.dynz_base_accel}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_active VALUE=False
            {% endif %}

        
        {% endif %}

        # --- E: APPLY TEMPERATURE ---
        {% set new_target = (saved_base + smooth_boost)|round(0)|int %}
        {% set max_limit = vars.at_max_temp|default(300)|int %}
        {% if new_target > max_limit %} {% set new_target = max_limit %} {% endif %}
        {% if new_target < saved_base %} {% set new_target = saved_base|int %} {% endif %}

        # Only update if temp changed by at least 1°C
        {% set temp_diff = (new_target - current_setpoint)|abs %}
        {% if temp_diff >= 1 %} M104 S{new_target} {% endif %}

        # --- F: THERMAL SAFETY CHECK ---
        {% set actual_temp = printer.extruder.temperature|float %}
        {% set target_temp = printer.extruder.target|float %}
        {% set temp_deviation = actual_temp - target_temp %}
        
        # Skip thermal checks if heater is off (target = 0)
        {% if target_temp > 0 %}
        
        # Check for thermal runaway (temp too high)
        {% if temp_deviation > thermal_runaway_threshold %}
            {% set fault_count = printer["gcode_macro _AUTO_TEMP_CORE"].thermal_fault_count + 1 %}
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE={fault_count}
            
            {% if fault_count >= 3 %}
                # Multiple consecutive faults - emergency shutdown
                _AT_THERMAL_EMERGENCY reason="RUNAWAY" actual={actual_temp} target={target_temp}
            {% else %}
                # Single fault - reduce boost and warn
                RESPOND TYPE=error MSG="THERMAL WARNING: Temp {actual_temp}C exceeds target {target_temp}C by {temp_deviation|round(1)}C"
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
                M104 S{saved_base|int}  ; Drop to base temp immediately
            {% endif %}
        
        # Check for undertemp (heater not keeping up)
        {% elif temp_deviation < (0 - thermal_undertemp_threshold) %}
            RESPOND TYPE=echo MSG="THERMAL NOTICE: Temp {actual_temp}C is {(0-temp_deviation)|round(1)}C below target. Heater may be struggling."
            # Don't add more boost if heater can't keep up - reduce demand
            {% if smooth_boost > 10 %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE={smooth_boost * 0.5}
            {% endif %}
        
        {% else %}
            # Temp is within safe range - reset fault counter
            SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
        {% endif %}
        
        {% endif %}  # End target_temp > 0 guard

        # --- G: DYNAMIC PRESSURE ADVANCE ---
        # Higher temps = lower viscosity = less PA needed
        {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
        {% if cfg.pa_enable|default(True) and base_pa > 0 %}
            # Per-material PA scaling (set by AT_INIT_MATERIAL)
            {% set pa_k = vars.material_pa_boost_k|default(0.001)|float %}
            {% set pa_reduction = smooth_boost * pa_k %}
            {% set new_pa = base_pa - pa_reduction %}
            {% if new_pa < (base_pa * 0.5) %} {% set new_pa = base_pa * 0.5 %} {% endif %}
            {% if new_pa < 0.01 %} {% set new_pa = 0.01 %} {% endif %}
            {% set current_pa = printer.extruder.pressure_advance|float %}
            {% if (current_pa - new_pa)|abs > 0.005 %}
                SET_PRESSURE_ADVANCE ADVANCE={new_pa}
            {% endif %}
        {% endif %}
        
        # --- H: SMART COOLING ---
        {% if cfg.sc_enable %}
            {% set now = printer.system_stats.cputime|default(0)|float %}
            {% set last_layer_z = cfg.sc_last_z|default(0)|float %}
            {% set last_layer_time = cfg.sc_last_z_time|default(0)|float %}
            
            # Detect layer change (Z increased)
            {% if current_z > last_layer_z + 0.05 %}
                {% set layer_duration = now - last_layer_time %}
                {% if layer_duration > 0.5 %}  # Ignore rapid Z hops
                    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_layer_time VALUE={layer_duration}
                {% endif %}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z VALUE={current_z}
                SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z_time VALUE={now}
            {% endif %}
            
            # Calculate fan speed
            {% set is_first_layer = current_z < (cfg.first_layer_height + 0.1) %}
            {% if is_first_layer %}
                {% set target_fan = cfg.sc_first_layer_fan %}
            {% else %}
                # Get base fan (from config or current slicer setting)
                {% set base_fan = cfg.sc_base_fan|float %}
                {% if base_fan <= 0 %}
                    {% set base_fan = (printer.fan.speed|default(0.5)|float) %}
                {% else %}
                    {% set base_fan = base_fan / 255.0 %}  # Convert 0-255 to 0-1
                {% endif %}
                
                # Per-material overrides (set by AT_INIT_MATERIAL)
                {% set sc_flow_gate = vars.material_sc_flow_gate|default(cfg.sc_flow_gate)|float %}
                {% set sc_flow_k = vars.material_sc_flow_k|default(cfg.sc_flow_k)|float %}
                {% set sc_min_fan = vars.material_sc_min_fan|default(cfg.sc_min_fan)|float %}
                {% set sc_max_fan = vars.material_sc_max_fan|default(cfg.sc_max_fan)|float %}
                
                # Use lookahead flow (same as temperature control)
                # Pre-reduce fan when high-flow section is approaching
                {% set predicted_flow = (printer["extruder_monitor"].predicted_extrusion_rate|default(0)|float * 2.405) if "extruder_monitor" in printer else 0.0 %}
                {% set effective_flow = [smooth_vol_flow, predicted_flow]|max %}
                
                # Flow-based reduction: high flow = less fan needed
                {% set flow_excess = effective_flow - sc_flow_gate %}
                {% if flow_excess > 0 %}
                    {% set flow_reduction = flow_excess * sc_flow_k %}
                {% else %}
                    {% set flow_reduction = 0 %}
                {% endif %}
                
                # Layer time boost: fast layers = more fan needed
                {% set layer_time = cfg.sc_layer_time|default(999)|float %}
                {% if layer_time < cfg.sc_short_layer_time %}
                    {% set time_deficit = cfg.sc_short_layer_time - layer_time %}
                    {% set layer_boost = time_deficit * cfg.sc_layer_time_k %}
                {% else %}
                    {% set layer_boost = 0 %}
                {% endif %}
                
                # Calculate final fan speed
                {% set target_fan = base_fan - flow_reduction + layer_boost %}
                
                # Clamp to limits
                {% if target_fan < sc_min_fan %} {% set target_fan = sc_min_fan %} {% endif %}
                {% if target_fan > sc_max_fan %} {% set target_fan = sc_max_fan %} {% endif %}
            {% endif %}
            
            # Apply fan speed (only if changed significantly)
            # Skip if sc_max_fan is 0 (Smart Cooling disabled for this material - let slicer control)
            {% set current_fan = printer.fan.speed|default(0)|float %}
            {% if sc_max_fan > 0 and (current_fan - target_fan)|abs > 0.03 %}
                M106 S{(target_fan * 255)|int}
            {% endif %}
        {% endif %}
        
        # Log data point for session analysis
        {% set actual_temp = printer.extruder.temperature|default(0)|float %}
        {% set current_pa = printer.extruder.pressure_advance|default(0)|float %}
        {% set predicted_flow = (printer["extruder_monitor"].predicted_extrusion_rate|default(0)|float * 2.405) if "extruder_monitor" in printer else 0.0 %}
        {% set log_boost = smooth_boost|default(0)|float %}
        {% set log_flow = smooth_vol_flow|default(0)|float %}
        {% set log_speed = toolhead_speed|default(0)|float %}
        {% set log_pwm = heater_power|default(0)|float %}
        {% set log_z = current_z|default(0)|float %}
        {% set log_dynz_active = 1 if cfg.dynz_active else 0 %}
        {% set log_accel = printer.toolhead.max_accel|default(0)|int %}
        {% set log_fan = (printer.fan.speed|default(0)|float * 100)|int %}
        AT_LOG_DATA TEMP={actual_temp} TARGET={new_target} BOOST={log_boost|round(1)} FLOW={log_flow|round(2)} SPEED={log_speed|round(1)} PWM={log_pwm|round(3)} PA={current_pa|round(4)} Z={log_z|round(2)} PREDICTED={predicted_flow|round(2)} DYNZ={log_dynz_active} ACCEL={log_accel} FAN={log_fan}
        
    {% else %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
        {% if not vars.at_enabled|default(False) %}
            UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
        {% endif %}
    {% endif %}

# =========================================================
#  2. THERMAL SAFETY
# =========================================================
# =========================================================
[gcode_macro _AT_THERMAL_EMERGENCY]
description: Emergency thermal shutdown - called when runaway detected
gcode:
    {% set reason = params.REASON|default("UNKNOWN")|string %}
    {% set actual = params.ACTUAL|default(0)|float %}
    {% set target = params.TARGET|default(0)|float %}
    
    # Immediately disable auto-temp
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    
    # Turn off heater (set to 0)
    M104 S0
    
    # Pause print
    PAUSE
    
    # Alert user
    RESPOND TYPE=error MSG="!!! THERMAL EMERGENCY !!!"
    RESPOND TYPE=error MSG="Reason: {reason}"
    RESPOND TYPE=error MSG="Actual: {actual}C | Target: {target}C"
    RESPOND TYPE=error MSG="Heater OFF - Print PAUSED - Auto-Temp DISABLED"
    RESPOND TYPE=error MSG="Check hotend and thermistor before resuming!"
    
    M117 THERMAL EMERGENCY - CHECK HOTEND!

[gcode_macro AT_THERMAL_STATUS]
description: Display current thermal safety status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set actual = printer.extruder.temperature|float %}
    {% set target = printer.extruder.target|float %}
    {% set base = vars.base_print_temp|default(0)|float %}
    {% set boost = cfg.current_boost %}
    {% set faults = cfg.thermal_fault_count %}
    
    {% set deviation = actual - target %}
    {% set runaway_limit = cfg.thermal_runaway_threshold %}
    {% set undertemp_limit = cfg.thermal_undertemp_threshold %}
    
    RESPOND MSG="===== THERMAL STATUS ====="
    RESPOND MSG="Actual: {actual|round(1)}C | Target: {target|round(1)}C"
    RESPOND MSG="Base: {base|round(1)}C | Boost: +{boost|round(1)}C"
    RESPOND MSG="Deviation: {deviation|round(1)}C"
    RESPOND MSG="Limits: Runaway +{runaway_limit}C | Undertemp -{undertemp_limit}C"
    RESPOND MSG="Fault Count: {faults}/3"
    {% if vars.at_enabled|default(False) %}
        RESPOND MSG="Status: ACTIVE"
    {% else %}
        RESPOND MSG="Status: DISABLED"
    {% endif %}
    RESPOND MSG="=========================="

[gcode_macro AT_STATUS]
description: Display full Adaptive Flow system status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    
    # System state
    {% set enabled = vars.at_enabled|default(False) %}
    {% set base_temp = vars.base_print_temp|default(0)|float %}
    {% set max_temp = vars.at_max_temp|default(300)|int %}
    {% set flow_k = vars.material_flow_k|default(0)|float %}
    
    # Current values from macro state
    {% set boost = cfg.current_boost %}
    {% set fault_count = cfg.thermal_fault_count %}
    
    # Configuration
    {% set use_hf = cfg.use_high_flow_nozzle %}
    
    # Thermal info
    {% set actual_temp = printer.extruder.temperature|float %}
    {% set target_temp = printer.extruder.target|float %}
    {% set current_pa = printer.extruder.pressure_advance|default(0)|float %}
    {% set base_pa = cfg.base_pa|default(0)|float %}
    
    # Flow and lookahead data
    {% set predicted = printer["extruder_monitor"].predicted_extrusion_rate|default(0)|float if "extruder_monitor" in printer else 0.0 %}
    {% set last_vol_flow = cfg.last_vol_flow|default(0)|float %}
    
    RESPOND MSG="╔═══════════════════════════════════════════╗"
    RESPOND MSG="║      ADAPTIVE FLOW STATUS                 ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    
    # System State
    {% if enabled %}
        RESPOND MSG="║ System: ✓ ENABLED                         ║"
    {% else %}
        RESPOND MSG="║ System: ✗ DISABLED                        ║"
    {% endif %}
    
    # Hotend Type
    {% if use_hf %}
        RESPOND MSG="║ Hotend: Revo HF (High Flow)               ║"
    {% else %}
        RESPOND MSG="║ Hotend: Revo Standard                     ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ TEMPERATURE                               ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Actual:    {"%6.1f"|format(actual_temp)}°C                        ║"
    RESPOND MSG="║ Target:    {"%6.1f"|format(target_temp)}°C                        ║"
    RESPOND MSG="║ Base:      {"%6.1f"|format(base_temp)}°C                        ║"
    RESPOND MSG="║ Boost:     {"%+6.1f"|format(boost)}°C                        ║"
    RESPOND MSG="║ Max Limit: {"%6d"|format(max_temp)}°C                        ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ PRESSURE ADVANCE                          ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ Current PA: {"%6.3f"|format(current_pa)}                         ║"
    RESPOND MSG="║ Base PA:    {"%6.3f"|format(base_pa)}                         ║"

    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ FLOW & SPEED                              ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set flow_gate = vars.material_flow_gate|default(0)|float %}
    {% set toolhead_speed = printer.motion_report.live_velocity|default(0)|float %}
    {% set speed_threshold = cfg.speed_boost_threshold|default(100.0)|float %}
    RESPOND MSG="║ Flow K:      {"%6.2f"|format(flow_k)}                         ║"
    RESPOND MSG="║ Flow Gate:  {"%6.1f"|format(flow_gate)} mm³/s               ║"
    RESPOND MSG="║ Current Flow:{"%6.2f"|format(last_vol_flow)} mm³/s               ║"
    RESPOND MSG="║ Toolhead:   {"%6.1f"|format(toolhead_speed)} mm/s (>{speed_threshold|int})   ║"
    {% if predicted > 0 %}
        RESPOND MSG="║ Predicted:   {"%6.2f"|format(predicted)} mm/s                  ║"
    {% else %}
        RESPOND MSG="║ Predicted:   ------ (idle)                 ║"
    {% endif %}
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ SAFETY                                    ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set heater_power = printer.extruder.power|default(0)|float %}
    {% set power_pct = (heater_power * 100)|round(0)|int %}
    {% set current_z = printer.toolhead.position.z|float %}
    {% set first_layer_h = cfg.first_layer_height|default(0.3)|float %}
    {% set first_layer_skip = cfg.first_layer_skip|default(True) %}
    {% set on_first_layer = first_layer_skip and (current_z <= first_layer_h + 0.05) %}
    RESPOND MSG="║ Heater PWM:   {"%5d"|format(power_pct)}%                        ║"
    RESPOND MSG="║ Z Height:    {"%6.2f"|format(current_z)} mm                     ║"
    {% if on_first_layer %}
        RESPOND MSG="║ First Layer: YES (boost disabled)         ║"
    {% else %}
        RESPOND MSG="║ First Layer: NO                           ║"
    {% endif %}
    RESPOND MSG="║ Thermal Faults: {fault_count}/3                        ║"
    
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    RESPOND MSG="║ MULTI-OBJECT PRINTING                     ║"
    RESPOND MSG="╠═══════════════════════════════════════════╣"
    {% set multi_obj_enabled = cfg.multi_object_temp_wait|default(True) %}
    {% set temp_tolerance = cfg.temp_wait_tolerance|default(5.0)|float %}
    {% if multi_obj_enabled %}
        RESPOND MSG="║ Temp Wait:  ✓ ENABLED                     ║"
        RESPOND MSG="║ Tolerance:  ±{"%4.1f"|format(temp_tolerance)}°C                        ║"
    {% else %}
        RESPOND MSG="║ Temp Wait:  ✗ DISABLED                    ║"
    {% endif %}
    
    RESPOND MSG="╚═══════════════════════════════════════════╝"


[gcode_macro AT_DYNZ_STATUS]
description: Display live Dynamic Z-Window (DynZ) status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}

    {% set enabled = cfg.dynz_enable %}
    {% set active = cfg.dynz_active %}
    {% set current_z = printer.toolhead.position.z|float %}
    {% set bin_h = cfg.dynz_bin_height|float %}
    {% set z_bin = (current_z / bin_h)|int %}
    {% set bin_key = "dynz_bin_" ~ z_bin %}
    {% set bin_score = vars[bin_key]|default(0.0)|float %}

    {% set base_accel = cfg.dynz_base_accel|default(0)|int %}
    {% set relief_accel = cfg.dynz_accel_relief|int %}
    {% set current_accel = printer.toolhead.max_accel|int %}

    RESPOND MSG="===== DYNZ STATUS ====="

    {% if enabled %}
        RESPOND MSG="DynZ: ENABLED"
    {% else %}
        RESPOND MSG="DynZ: DISABLED"
    {% endif %}

    {% if active %}
        RESPOND MSG="State: ACTIVE (accel relief applied)"
    {% else %}
        RESPOND MSG="State: INACTIVE"
    {% endif %}

    RESPOND MSG="Z Height: {current_z|round(2)} mm"
    RESPOND MSG="Z Bin: {z_bin} (bin height {bin_h} mm)"
    RESPOND MSG="Bin Score: {bin_score|round(2)}"
    RESPOND MSG="Activate ≥ {cfg.dynz_activate_score}"
    RESPOND MSG="Deactivate ≤ {cfg.dynz_deactivate_score}"

    RESPOND MSG="Accel (current): {current_accel} mm/s²"
    RESPOND MSG="Accel (base):    {base_accel} mm/s²"
    RESPOND MSG="Accel (relief):  {relief_accel} mm/s²"

    {% if active %}
        RESPOND MSG="Mode: CLAMPING (convex stress detected)"
    {% elif bin_score > 0 %}
        RESPOND MSG="Mode: LEARNING (accumulating history)"
    {% else %}
        RESPOND MSG="Mode: IDLE"
    {% endif %}

    RESPOND MSG="======================="

[gcode_macro AT_SC_STATUS]
description: Display Smart Cooling status
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set vars = printer.save_variables.variables %}
    {% set current_fan = printer.fan.speed|default(0)|float %}
    
    RESPOND MSG="===== SMART COOLING STATUS ====="
    
    {% if cfg.sc_enable %}
        RESPOND MSG="Smart Cooling: ENABLED"
    {% else %}
        RESPOND MSG="Smart Cooling: DISABLED"
    {% endif %}
    
    RESPOND MSG="Current Fan: {(current_fan * 100)|round(0)}%"
    RESPOND MSG="Layer Time: {cfg.sc_layer_time|round(1)}s"
    
    # Show material overrides if set
    {% set sc_min = vars.material_sc_min_fan|default(cfg.sc_min_fan)|float %}
    {% set sc_max = vars.material_sc_max_fan|default(cfg.sc_max_fan)|float %}
    RESPOND MSG="Fan Range: {(sc_min * 100)|round(0)}% - {(sc_max * 100)|round(0)}%"
    
    {% set sc_flow_gate = vars.material_sc_flow_gate|default(cfg.sc_flow_gate)|float %}
    RESPOND MSG="Flow Gate: {sc_flow_gate} mm³/s"
    RESPOND MSG="Short Layer Threshold: {cfg.sc_short_layer_time}s"
    
    RESPOND MSG="================================="

# =========================================================
#  3. CONTROL & LOOP MACROS
# =========================================================
[delayed_gcode AUTO_TEMP_LOOP]
initial_duration: 0
gcode:
    {% if printer.save_variables.variables.at_enabled|default(False) %}
        _AUTO_TEMP_CORE
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_RESET_STATE]
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_stable_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=thermal_fault_count VALUE=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    # Reset DynZ state
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% if cfg.dynz_active and cfg.dynz_base_accel > 0 %}
        SET_VELOCITY_LIMIT ACCEL={cfg.dynz_base_accel}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_base_accel VALUE=0
    # Reset Smart Cooling state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z_time VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_layer_time VALUE=999.0
    RESPOND MSG="Auto-Temp: State reset complete"

    
[gcode_macro AT_ENABLE]
gcode:
    {% set current_target = printer.extruder.target|float %}
    {% if current_target < 170 %}
        RESPOND TYPE=error MSG="Auto-Temp: Heat nozzle first."
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% else %}
        SAVE_VARIABLE VARIABLE=base_print_temp VALUE={current_target}
        SAVE_VARIABLE VARIABLE=at_enabled VALUE=True
        {% set current_pa = printer.extruder.pressure_advance|default(0.0)|float %}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={current_pa}
        RESPOND MSG="Auto-Temp: Enabled. Base {current_target}C / PA {current_pa}"
        UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=1.0
    {% endif %}

[gcode_macro AT_DISABLE]
gcode:
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    {% set base = printer.save_variables.variables.base_print_temp|default(0)|float %}
    {% if base > 100 %} M104 S{base} {% endif %}
    {% set base_pa = printer["gcode_macro _AUTO_TEMP_CORE"].base_pa|default(0.0)|float %}
    {% if base_pa > 0 %} SET_PRESSURE_ADVANCE ADVANCE={base_pa} {% endif %}
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    RESPOND MSG="Auto-Temp: Disabled."

# Tuning Macros
[gcode_macro AT_SET_FLOW_K]
description: Set the flow-based temperature boost coefficient
gcode:
    {% set k = params.K|default(0)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_k VALUE={k}
    RESPOND MSG="Flow K set to {k}"

[gcode_macro AT_SET_FLOW_GATE]
description: Set the minimum flow rate (mm³/s) to trigger temperature boost
gcode:
    {% set gate = params.GATE|default(10)|float %}
    SAVE_VARIABLE VARIABLE=material_flow_gate VALUE={gate}
    RESPOND MSG="Flow gate set to {gate} mm³/s"

[gcode_macro AT_SET_MAX]
gcode:
    SAVE_VARIABLE VARIABLE=at_max_temp VALUE={params.MAX|default(300)|int}

[gcode_macro AT_INIT_MATERIAL]
description: Load material profile and apply settings
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Read hotend type from shared config variable in _AUTO_TEMP_CORE
    {% set use_hf = printer["gcode_macro _AUTO_TEMP_CORE"].use_high_flow_nozzle %}
    
    # =========================================================
    # LOAD PROFILE FROM material_profiles.cfg
    # Tries exact match first, then known mappings, then DEFAULT
    # =========================================================
    
    # Map material variants to base profiles
    {% set profile_name = "DEFAULT" %}
    {% if 'PLA' in material %}
        {% set profile_name = "PLA" %}
    {% elif 'PETG' in material or 'PET' in material %}
        {% set profile_name = "PETG" %}
    {% elif 'ASA' in material %}
        {% set profile_name = "ASA" %}
    {% elif 'ABS' in material %}
        {% set profile_name = "ABS" %}
    {% elif 'TPU' in material or 'TPE' in material or 'FLEX' in material %}
        {% set profile_name = "TPU" %}
    {% elif 'NYLON' in material or 'PA6' in material or 'PA12' in material %}
        {% set profile_name = "NYLON" %}
    {% elif 'PC' in material or 'POLYCARB' in material %}
        {% set profile_name = "PC" %}
    {% elif 'HIPS' in material %}
        {% set profile_name = "HIPS" %}
    {% endif %}
    
    # Try to load the profile macro
    {% set profile_macro = "_AF_PROFILE_" ~ profile_name %}
    {% set profile = printer["gcode_macro " ~ profile_macro]|default(none) %}
    
    # Fallback to DEFAULT if profile not found
    {% if profile is none %}
        {% set profile = printer["gcode_macro _AF_PROFILE_DEFAULT"] %}
        {% set profile_name = "DEFAULT" %}
    {% endif %}
    
    # Read values from profile
    {% set flow_k = profile.flow_k|default(0.5)|float %}
    {% set speed_boost_k = profile.speed_boost_k|default(0.06)|float %}
    {% set max_boost = profile.max_boost|default(35.0)|float %}
    {% set max_temp_safety = profile.max_temp|default(280)|int %}
    {% set pa_boost_k = profile.pa_boost_k|default(0.001)|float %}
    {% set ramp_rise = profile.ramp_rise|default(4.0)|float %}
    {% set ramp_fall = profile.ramp_fall|default(1.5)|float %}
    {% set default_pa = profile.default_pa|default(0.040)|float %}
    
    # Select flow gate based on nozzle type
    {% if use_hf %}
        {% set flow_gate = profile.flow_gate|default(10.0)|float %}
    {% else %}
        {% set flow_gate = profile.flow_gate_std|default(8.0)|float %}
    {% endif %}
    
    # =========================================================
    # GET PA: User-calibrated value OR profile default
    # =========================================================
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_")|replace("-", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    {% if saved_pa >= 0 %}
        {% set pa_val = saved_pa %}
        {% set pa_source = "calibrated" %}
    {% else %}
        {% set pa_val = default_pa %}
        {% set pa_source = "default" %}
    {% endif %}

    # --- APPLY ---
    # Save all per-material boost curve parameters
    SAVE_VARIABLE VARIABLE=material_ramp_rise VALUE={ramp_rise}
    SAVE_VARIABLE VARIABLE=material_ramp_fall VALUE={ramp_fall}
    SAVE_VARIABLE VARIABLE=material_speed_boost_k VALUE={speed_boost_k}
    SAVE_VARIABLE VARIABLE=material_max_boost VALUE={max_boost}
    SAVE_VARIABLE VARIABLE=material_pa_boost_k VALUE={pa_boost_k}
    
    # Save Smart Cooling parameters from profile
    {% set sc_flow_gate = profile.sc_flow_gate|default(8.0)|float %}
    {% set sc_flow_k = profile.sc_flow_k|default(0.03)|float %}
    {% set sc_min_fan = profile.sc_min_fan|default(0.20)|float %}
    {% set sc_max_fan = profile.sc_max_fan|default(1.00)|float %}
    SAVE_VARIABLE VARIABLE=material_sc_flow_gate VALUE={sc_flow_gate}
    SAVE_VARIABLE VARIABLE=material_sc_flow_k VALUE={sc_flow_k}
    SAVE_VARIABLE VARIABLE=material_sc_min_fan VALUE={sc_min_fan}
    SAVE_VARIABLE VARIABLE=material_sc_max_fan VALUE={sc_max_fan}
    
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
        SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=base_pa VALUE={pa_val}
        RESPOND MSG="PA: {pa_val} ({pa_source})"
    {% endif %}

    {% if flow_k > 0 %}
        AT_SET_FLOW_K K={flow_k}
        AT_SET_FLOW_GATE GATE={flow_gate}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow: ON ({material} -> {profile_name} profile)"
        RESPOND MSG="  Flow K={flow_k}, Speed K={speed_boost_k}, Max Boost={max_boost}C"
        RESPOND MSG="  Ramp: +{ramp_rise}/-{ramp_fall} C/s, Flow gate={flow_gate}mm3/s"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow: OFF ({material})"  
    {% endif %}

# =========================================================
#  PA CALIBRATION MACROS
# =========================================================
[gcode_macro AT_SET_PA]
description: Save calibrated PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper|replace(" ", "_") %}
    {% set pa = params.PA|default(0.04)|float %}
    
    {% if pa < 0 or pa > 1.0 %}
        RESPOND TYPE=error MSG="PA value must be between 0 and 1.0"
    {% else %}
        SAVE_VARIABLE VARIABLE=pa_{material|lower} VALUE={pa}
        RESPOND MSG="Saved PA for {material}: {pa}"
        RESPOND MSG="This will be used next time you run AT_INIT_MATERIAL MATERIAL={material}"
    {% endif %}

[gcode_macro AT_GET_PA]
description: Show saved or default PA value for a material
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set vars = printer.save_variables.variables %}
    
    # Get default PA from material profile
    {% set profile_name = material %}
    {% if 'PLA' in material %}{% set profile_name = "PLA" %}
    {% elif 'PETG' in material or 'PET' in material %}{% set profile_name = "PETG" %}
    {% elif 'ASA' in material %}{% set profile_name = "ASA" %}
    {% elif 'ABS' in material %}{% set profile_name = "ABS" %}
    {% elif 'TPU' in material or 'TPE' in material %}{% set profile_name = "TPU" %}
    {% elif 'NYLON' in material or 'PA' in material %}{% set profile_name = "NYLON" %}
    {% elif 'PC' in material %}{% set profile_name = "PC" %}
    {% elif 'HIPS' in material %}{% set profile_name = "HIPS" %}
    {% endif %}
    
    {% set profile = printer["gcode_macro _AF_PROFILE_" ~ profile_name]|default(printer["gcode_macro _AF_PROFILE_DEFAULT"]) %}
    {% set def_val = profile.default_pa|default(0.040)|float %}
    
    {% set pa_var_name = "pa_" ~ material|lower|replace(" ", "_") %}
    {% set saved_pa = vars[pa_var_name]|default(-1)|float %}
    
    RESPOND MSG="===== PA for {material} ====="
    {% if saved_pa >= 0 %}
        RESPOND MSG="Saved (calibrated): {saved_pa}"
    {% else %}
        RESPOND MSG="Saved: None (not calibrated)"
    {% endif %}
    
    RESPOND MSG="Profile default ({profile_name}): {def_val}"
    
    {% if saved_pa >= 0 %}
        RESPOND MSG="Will use: {saved_pa} (calibrated)"
    {% else %}
        RESPOND MSG="Will use: {def_val} (profile default)"
    {% endif %}

[gcode_macro AT_LIST_PA]
description: List all saved PA values and defaults
gcode:
    {% set vars = printer.save_variables.variables %}
    
    # Read defaults from material profile macros
    {% set materials = ['PLA', 'PETG', 'ABS', 'ASA', 'TPU', 'NYLON', 'PC', 'HIPS'] %}
    
    RESPOND MSG="===== PRESSURE ADVANCE VALUES ====="
    RESPOND MSG="Material | Saved | Profile Default"
    RESPOND MSG="---------|-------|----------------"
    {% for mat in materials %}
        {% set profile = printer["gcode_macro _AF_PROFILE_" ~ mat]|default(none) %}
        {% set def_pa = profile.default_pa|default(0.040)|float if profile else 0.040 %}
        {% set saved = vars["pa_" ~ mat|lower]|default(-1)|float %}
        {% if saved >= 0 %}
            RESPOND MSG="{mat}: {saved} (calibrated) | {def_pa}"
        {% else %}
            RESPOND MSG="{mat}: - | {def_pa}"
        {% endif %}
    {% endfor %}
    RESPOND MSG="===================================="
    RESPOND MSG="To calibrate: AT_SET_PA MATERIAL=<name> PA=<value>"

# =========================================================================
# MULTI-OBJECT TEMPERATURE MANAGEMENT
# =========================================================================
# These macros handle temperature stabilization between objects to prevent
# thermal runaway shutdowns when printing multiple objects sequentially.
# =========================================================================

[gcode_macro AT_WAIT_TEMP]
description: Wait for nozzle temperature to stabilize to target (internal use)
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set target_temp = printer.extruder.target|float %}
    {% set current_temp = printer.extruder.temperature|float %}
    {% set tolerance = cfg.temp_wait_tolerance|default(5.0)|float %}
    {% set timeout = cfg.temp_wait_timeout|default(300)|int %}
    
    # Calculate temperature difference
    {% set temp_diff = (current_temp - target_temp)|abs %}
    
    # Check if we need to wait
    {% if temp_diff > tolerance %}
        {% if current_temp > target_temp %}
            RESPOND MSG="AT_WAIT_TEMP: Cooling from {current_temp:.1f}°C to {target_temp:.1f}°C (tolerance: ±{tolerance:.1f}°C)"
        {% else %}
            RESPOND MSG="AT_WAIT_TEMP: Heating from {current_temp:.1f}°C to {target_temp:.1f}°C (tolerance: ±{tolerance:.1f}°C)"
        {% endif %}
        
        # Wait for temperature using Klipper's built-in command
        # Note: TEMPERATURE_WAIT doesn't have timeout in Klipper, but it's safe
        # because the heater is already set to the target by the slicer/print start
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={(target_temp - tolerance)} MAXIMUM={(target_temp + tolerance)}
        
        {% set final_temp = printer.extruder.temperature|float %}
        RESPOND MSG="AT_WAIT_TEMP: Temperature stabilized at {final_temp:.1f}°C"
    {% else %}
        RESPOND MSG="AT_WAIT_TEMP: Temperature within tolerance ({current_temp:.1f}°C vs target {target_temp:.1f}°C)"
    {% endif %}

[gcode_macro EXCLUDE_OBJECT_START]
rename_existing: EXCLUDE_OBJECT_START_BASE
description: Start printing an object (with optional temperature wait)
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set multi_object_enabled = cfg.multi_object_temp_wait|default(True) %}
    
    # Check if adaptive flow is active and multi-object temp wait is enabled
    {% set vars = printer.save_variables.variables %}
    {% set at_enabled = vars.at_enabled|default(False) %}
    
    {% if at_enabled and multi_object_enabled %}
        # Wait for temperature to stabilize before starting next object
        AT_WAIT_TEMP
    {% endif %}
    
    # Call the original EXCLUDE_OBJECT_START command
    EXCLUDE_OBJECT_START_BASE {rawparams}

[gcode_macro M486]
description: Handle M486 object labeling (legacy compatibility)
gcode:
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set multi_object_enabled = cfg.multi_object_temp_wait|default(True) %}
    
    # M486 S<index> - Start object (switch to printing object)
    {% if params.S is defined %}
        # Check if adaptive flow is active and multi-object temp wait is enabled
        {% set vars = printer.save_variables.variables %}
        {% set at_enabled = vars.at_enabled|default(False) %}
        
        {% if at_enabled and multi_object_enabled %}
            # Wait for temperature to stabilize before starting next object
            AT_WAIT_TEMP
        {% endif %}
    {% endif %}
    
    # Note: M486 P<index> defines objects and M486 E<index> cancels objects
    # We only care about S (start) for temperature management

# =========================================================================
# ZERO-CONFIG ENTRY POINT
# =========================================================================
# AT_START: Call this in your PRINT_START macro after heating.
#
# USAGE:
#   AT_START MATERIAL=PETG    (recommended - pass from slicer)
#   AT_START                   (auto-detects from temperature)
#
# SLICER SETUP:
#   1. Pass material to PRINT_START: MATERIAL={filament_type[0]}
#   2. DISABLE Pressure Advance in slicer (this system handles PA dynamically)
#
# The MATERIAL parameter is optional but recommended for accurate profiles.
# If omitted, material is detected from extruder temperature.
# =========================================================================

[gcode_macro AT_START]
description: Start adaptive temperature - optionally pass MATERIAL from slicer
gcode:
    # Get material from slicer parameter (preferred) or detect from temp
    {% set slicer_material = params.MATERIAL|default("")|string|upper|replace(" ", "")|replace("-", "") %}
    {% set target_temp = printer.extruder.target|default(0)|int %}
    {% set vars = printer.save_variables.variables %}
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    
    # Warn if no temperature set (AT_START called before heating commands)
    {% if target_temp < 150 %}
        RESPOND TYPE=echo MSG="AT_START: Warning - extruder target is {target_temp}C. Call AT_START AFTER your heating commands (M104/M109)."
        {% set target_temp = 200 %}
    {% endif %}
    
    # Normalize common material name variations
    {% set material = "PLA" %}  # Default fallback
    
    {% if slicer_material != "" %}
        # Material explicitly passed from slicer - use it!
        # Normalize variations: "PLA+", "PLA-CF", "PETG-GF" etc.
        {% if "PLA" in slicer_material %}
            {% set material = "PLA" %}
        {% elif "PETG" in slicer_material or "PET" in slicer_material %}
            {% set material = "PETG" %}
        {% elif "ABS" in slicer_material %}
            {% set material = "ABS" %}
        {% elif "ASA" in slicer_material %}
            {% set material = "ASA" %}
        {% elif "TPU" in slicer_material or "TPE" in slicer_material or "FLEX" in slicer_material %}
            {% set material = "TPU" %}
        {% elif "NYLON" in slicer_material or "PA" in slicer_material %}
            {% set material = "NYLON" %}
        {% elif "PC" in slicer_material or "POLYCARB" in slicer_material %}
            {% set material = "PC" %}
        {% elif "HIPS" in slicer_material %}
            {% set material = "HIPS" %}
        {% else %}
            # Unknown material - use as-is, AT_INIT_MATERIAL will handle defaults
            {% set material = slicer_material %}
        {% endif %}
        RESPOND MSG="AT_START: Material '{material}' from slicer ({slicer_material})"
    {% else %}
        # No material passed - fall back to temperature detection
        {% if target_temp >= 280 %}
            {% set material = "PC" %}
        {% elif target_temp >= 260 %}
            {% set material = "NYLON" %}
        {% elif target_temp >= 240 %}
            {% set material = "ABS" %}
        {% elif target_temp >= 220 %}
            {% set material = "PETG" %}
        {% elif target_temp >= 180 %}
            {% set material = "PLA" %}
        {% elif target_temp >= 160 %}
            {% set material = "TPU" %}
        {% endif %}
        RESPOND TYPE=echo MSG="AT_START: No MATERIAL param - auto-detected '{material}' from {target_temp}C"
    {% endif %}
    
    # Store detected material
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=detected_material VALUE="'{material}'"

    # =========================================================
    # RESET DYNAMIC Z-WINDOW STATE (PER-PRINT)
    # =========================================================
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_base_accel VALUE=0
    
    # Initialize material settings (K-values, PA, safety limits)
    AT_INIT_MATERIAL MATERIAL={material}
    
    # Start logging session with feature flags
    {% set print_file = printer.print_stats.filename|default("unknown") %}
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% set at_on = 1 if cfg.at_enabled|default(True) else 0 %}
    {% set dynz_on = 1 if cfg.dynz_enable|default(True) else 0 %}
    {% set sc_on = 1 if cfg.sc_enable|default(True) else 0 %}
    {% set pa_on = 1 if cfg.pa_enable|default(True) else 0 %}
    AT_LOG_START MATERIAL={material} FILE="{print_file}" AT_ENABLED={at_on} DYNZ_ENABLED={dynz_on} SC_ENABLED={sc_on} PA_ENABLED={pa_on}
    
    RESPOND MSG="AT_START: Adaptive Temperature enabled for {material}"

[gcode_macro AT_END]
description: Clean shutdown of adaptive temperature at print end
gcode:
    # Stop the loop immediately
    UPDATE_DELAYED_GCODE ID=AUTO_TEMP_LOOP DURATION=0
    SAVE_VARIABLE VARIABLE=at_enabled VALUE=False
    
    # Restore acceleration if DynZ was active
    {% set cfg = printer["gcode_macro _AUTO_TEMP_CORE"] %}
    {% if cfg.dynz_active and cfg.dynz_base_accel > 0 %}
        SET_VELOCITY_LIMIT ACCEL={cfg.dynz_base_accel}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_active VALUE=False
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=dynz_base_accel VALUE=0
    
    # End logging session
    AT_LOG_END
    
    # Reset per-print state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=last_vol_flow VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=current_boost VALUE=0.0
    # Reset Smart Cooling state
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_last_z_time VALUE=0.0
    SET_GCODE_VARIABLE MACRO=_AUTO_TEMP_CORE VARIABLE=sc_layer_time VALUE=999.0
    
    RESPOND MSG="AT_END: Adaptive Temperature disabled"
