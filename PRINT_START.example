[gcode_macro PRINT_START]
gcode:
    # =================================================================
    # 1. PARAMETER SETUP
    # =================================================================
    # Get parameters from Slicer
    {% set target_bed      = params.BED|default(60)|int %}
    {% set target_extruder = params.EXTRUDER|default(200)|int %}
    {% set material        = params.MATERIAL|default("PLA")|string %}
    
    # Internal Defaults (Fixed the "Undefined" errors)
    {% set tol = 2 %}            # Bed temperature tolerance (+/- degrees)
    {% set soak_min = 0 %}       # Heat soak time (default 0 to skip)
    {% set probe_temp = 150 %}   # Safe temp for probing/meshing (no ooze)
    {% set do_mesh = 1 %}        # Set to 1 to force mesh, 0 to load saved

    # Geometry for Prime Line
    {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
    {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

    # =================================================================
    # 2. MATERIAL LOGIC (Calculate K-Values & PA)
    # =================================================================
    {% set load_k = 0.0 %}   
    {% set speed_k = 0.0 %}  
    {% set pa_val = 0.0 %}
    {% set max_temp_safety = 300 %}

    {% if 'PLA' in material %}
        {% set load_k = 0.10 %}
        {% set speed_k = 0.50 %}
        {% set pa_val = 0.040 %}
        {% set max_temp_safety = 235 %}
        
    {% elif 'PETG' in material %}
        {% set load_k = 0.15 %}
        {% set speed_k = 0.60 %}
        {% set pa_val = 0.060 %}
        {% set max_temp_safety = 265 %}
        
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set load_k = 0.20 %}
        {% set speed_k = 0.80 %}
        {% set pa_val = 0.050 %}
        {% set max_temp_safety = 290 %}
        
    {% elif 'PC' in material or 'NYLON' in material %}
        {% set load_k = 0.25 %}
        {% set speed_k = 0.90 %}
        {% set pa_val = 0.055 %}
        {% set max_temp_safety = 300 %}
        
    {% elif 'TPU' in material %}
        # Auto-Temp OFF for TPU
        {% set load_k = 0.0 %}
        {% set speed_k = 0.0 %}
        {% set pa_val = 0.20 %} 
        {% set max_temp_safety = 240 %}
    {% endif %}

    # =================================================================
    # 3. INITIAL PREP
    # =================================================================
    # Reset Auto-Flow State
    AT_RESET_STATE
    AT_DISABLE
    
    # Homing
    M117 Homing...
    G28
    G90

    # Heat Bed
    M117 Heating bed to {target_bed}C
    M140 S{target_bed}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target_bed - tol} MAXIMUM={target_bed + tol}

    # Optional Soak
    {% if soak_min > 0 %}
        M117 Soaking bed {soak_min} min...
        G4 P{soak_min * 60000}
    {% endif %}

    # Heat Nozzle to Probe Temp (prevents oozing)
    G1 X{x_wait} Y{y_wait} Z15 F9000
    M107
    M117 Nozzle to probe temp {probe_temp}C
    M104 S{probe_temp}
    M109 S{probe_temp}

    # =================================================================
    # 4. MESHING
    # =================================================================
    {% if do_mesh == 1 %}
        M117 Probing mesh...
        BED_MESH_CLEAR
        BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1
    {% else %}
        M117 Loading default mesh...
        BED_MESH_PROFILE LOAD=default
    {% endif %}

    # =================================================================
    # 5. FINAL HEATING & ACTIVATION
    # =================================================================
    M117 Heating nozzle to {target_extruder}C
    M104 S{target_extruder}
    M109 S{target_extruder}

    # Apply Pressure Advance
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
    {% endif %}

    # ENABLE ADAPTIVE FLOW (Must be done after reaching temp)
    {% if load_k > 0 or speed_k > 0 %}
        AT_SET_VISC_K K={load_k}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow ON: {material} | Load_K: {load_k} | Speed_K: {speed_k}"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow OFF: {material}"
    {% endif %}

    # =================================================================
    # 6. PRIME LINE
    # =================================================================
    M117 Priming...
    G0 X{x_wait - 50} Y4 F10000
    G0 Z0.4
    G91
    G1 X100 E20 F1000
    G90
    
    M117 Printing...


[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script
gcode:
        # 1. Disable Systems
    AT_DISABLE
    #   Get Boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}
    
    #   Check end position to determine safe directions to move
    {% if printer.toolhead.position.x < (max_x - 20) %}
        {% set x_safe = 20.0 %}
    {% else %}
        {% set x_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.y < (max_y - 20) %}
        {% set y_safe = 20.0 %}
    {% else %}
        {% set y_safe = -20.0 %}
    {% endif %}

    {% if printer.toolhead.position.z < (max_z - 2) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}
    
    #  Commence PRINT_END
    M400                             ; wait for buffer to clear
    G92 E0                           ; zero the extruder
    G1 E-4.0 F3600                   ; retract
    G91                              ; relative positioning
    G0 Z{z_safe} F3600               ; move nozzle up
    G0 X{x_safe} Y{y_safe} F20000    ; move nozzle to remove stringing
    
    M104 S0                          ; turn off hotend
    M140 S0                          ; turn off bed
    M106 S0                          ; turn off fan
    G90                              ; absolute positioning
    G0 X{max_x / 2} Y{max_y} F3600   ; park nozzle at rear
    M117 Finished!
