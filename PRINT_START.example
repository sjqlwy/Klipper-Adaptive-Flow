# =============================================================================
# SLICER SETUP (required)
# =============================================================================
# In your slicer's "Start G-code", add:
#   PRINT_START BED=[first_layer_bed_temperature] EXTRUDER=[first_layer_temperature] MATERIAL={filament_type[0]}
#
# IMPORTANT: Disable Pressure Advance in your slicer - Adaptive Flow handles it.
#   PrusaSlicer/OrcaSlicer: Printer Settings → Custom G-code → clear PA commands
#   Cura: Remove any SET_PRESSURE_ADVANCE from start g-code
#   SuperSlicer: Printer Settings → Firmware → disable "use firmware PA"
# =============================================================================

[gcode_macro PRINT_START]
gcode:
    # Get params from slicer (MATERIAL is required for Adaptive Flow)
    {% set BED = params.BED|default(60)|int %}
    {% set EXTRUDER = params.EXTRUDER|default(200)|int %}
    {% set MATERIAL = params.MATERIAL|string %}
    
    # Home
    G28
    G90
    
    # Heat bed
    M140 S{BED}
    M190 S{BED}
    
    # Optional: Bed mesh
    # BED_MESH_CALIBRATE ADAPTIVE=1
    
    # Heat nozzle
    M109 S{EXTRUDER}
    
    # Optional: Purge line
    # G1 X10 Y10 Z0.3 F3000
    # G1 X100 E10 F1500
    # G92 E0
    
    # Enable Adaptive Flow with material from slicer
    AT_START MATERIAL={MATERIAL}


[gcode_macro PRINT_END]
gcode:
    # Disable Adaptive Flow first (saves learned values)
    AT_END
    
    # Turn off heaters
    TURN_OFF_HEATERS
    M107
    
    # Retract and raise
    G91
    G1 E-2 F2700
    G1 Z10 F3000
    G90
    
    # Present print
    G1 X10 Y200 F6000
    
    # Motors off
    M84
