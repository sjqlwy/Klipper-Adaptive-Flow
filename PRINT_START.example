[gcode_macro PRINT_START]
gcode:
    # Get params from slicer
    {% set BED = params.BED|default(60)|int %}
    {% set EXTRUDER = params.EXTRUDER|default(200)|int %}
    {% set MATERIAL = params.MATERIAL|default("PLA")|string %}
    
    # Home
    G28
    G90
    
    # Heat bed
    M140 S{BED}
    M190 S{BED}
    
    # Optional: Bed mesh
    # BED_MESH_CALIBRATE ADAPTIVE=1
    
    # Heat nozzle
    M109 S{EXTRUDER}
    
    # Optional: Purge line
    # G1 X10 Y10 Z0.3 F3000
    # G1 X100 E10 F1500
    # G92 E0
    
    # Enable Adaptive Flow
    AT_START


[gcode_macro PRINT_END]
gcode:
    # Disable Adaptive Flow first (saves learned values)
    AT_END
    
    # Turn off heaters
    TURN_OFF_HEATERS
    M107
    
    # Retract and raise
    G91
    G1 E-2 F2700
    G1 Z10 F3000
    G90
    
    # Present print
    G1 X10 Y200 F6000
    
    # Motors off
    M84
