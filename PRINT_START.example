[gcode_macro PRINT_START]
gcode:
    # -----------------------------------------------------------
    # 1. Get Parameters
    # -----------------------------------------------------------
    {% set target_extruder = params.EXTRUDER|default(200)|int %}
    {% set material        = params.MATERIAL|default("PLA")|string %}

    # -----------------------------------------------------------
    # 2. Reset Auto-Flow State (REQUIRED at top of macro)
    # -----------------------------------------------------------
    AT_RESET_STATE
    AT_DISABLE

    # -----------------------------------------------------------
    # 3. Define Material Configs
    # -----------------------------------------------------------
    # Initialize Defaults
    {% set load_k = 0.0 %}   # Viscosity (TMC) Boost
    {% set speed_k = 0.0 %}  # Flow (Speed) Boost
    {% set pa_val = 0.0 %}   # Pressure Advance
    {% set max_temp_safety = 300 %}

    # Logic Block
    {% if 'PLA' in material %}
        {% set load_k = 0.10 %}
        {% set speed_k = 0.50 %}
        {% set pa_val = 0.040 %}
        {% set max_temp_safety = 235 %}
        
    {% elif 'PETG' in material %}
        {% set load_k = 0.15 %}
        {% set speed_k = 0.60 %}
        {% set pa_val = 0.060 %}
        {% set max_temp_safety = 265 %}
        
    {% elif 'ABS' in material or 'ASA' in material %}
        {% set load_k = 0.20 %}
        {% set speed_k = 0.80 %}
        {% set pa_val = 0.050 %}
        {% set max_temp_safety = 290 %}
        
    {% elif 'TPU' in material %}
        # Disable for flexible filaments
        {% set load_k = 0.0 %}
        {% set speed_k = 0.0 %}
        {% set pa_val = 0.20 %} 
        {% set max_temp_safety = 240 %}
    {% endif %}

    # -----------------------------------------------------------
    # 4. Your Standard Start Routine
    # -----------------------------------------------------------
    # Insert your Homing (G28), Bed Heat, QGL, and Mesh logic here.
    # ...
    # ...
    
    # Final Heating (Wait for Extruder)
    M109 S{target_extruder}

    # -----------------------------------------------------------
    # 5. Apply & Enable (MUST happen after heating)
    # -----------------------------------------------------------
    
    # Apply Pressure Advance
    {% if pa_val > 0 %}
        SET_PRESSURE_ADVANCE ADVANCE={pa_val}
    {% endif %}

    # Enable Adaptive Flow
    {% if load_k > 0 or speed_k > 0 %}
        AT_SET_VISC_K K={load_k}
        AT_SET_FLOW_K K={speed_k}
        AT_SET_MAX MAX={max_temp_safety}
        AT_ENABLE
        RESPOND MSG="Adaptive Flow ON: {material}"
    {% else %}
        AT_DISABLE
        RESPOND MSG="Adaptive Flow OFF: {material}"
    {% endif %}

    # Start Printing...


[gcode_macro PRINT_END]
gcode:
    # Disable system at end of print
    AT_DISABLE
    
    # ... Your standard end gcode ...
