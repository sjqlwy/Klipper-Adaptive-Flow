[gcode_macro PRINT_START]
gcode:
    # 1. Get Params
    {% set target_bed      = params.BED|default(60)|int %}
    {% set target_extruder = params.EXTRUDER|default(200)|int %}
    {% set material        = params.MATERIAL|default("PLA")|string %}
    
    # 2. Reset
    AT_RESET_STATE
    AT_DISABLE

    # 3. Prepare Machine (Mesh, Home, Heat)
    M117 Homing...
    G28
    G90

    M117 Heating Bed...
    M140 S{target_bed}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target_bed}

    M117 Meshing...
    # (Insert your mesh code here, e.g., BED_MESH_CALIBRATE ADAPTIVE=1)

    M117 Heating Nozzle...
    M109 S{target_extruder}

    # 4. INITIALIZE ADAPTIVE FLOW (One-Line Magic)
    AT_INIT_MATERIAL MATERIAL={material}

    # 5. Print
    M117 Printing...
    # (Insert Prime Line code here)


[gcode_macro PRINT_END]
gcode:
    # Disable system at end of print
    AT_DISABLE
    
    # ... Your standard end gcode ...
