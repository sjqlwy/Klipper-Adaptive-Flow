[gcode_macro PRINT_START]
gcode:
  ###################################################################
  # PRINT_START (Voron 2.4 + Adaptive Flow Zero-Config)
  ###################################################################

  # ---- 1. Get Parameters ----
  {% set target_bed       = params.BED|default(60)|int %}
  {% set target_extruder  = params.EXTRUDER|default(200)|int %}
  # MATERIAL parameter no longer needed - AT_START auto-detects from temperature

  # ---- 2. Reset Systems ----
  # Ensure standard Runout behavior (Enable SFS_T0)
  SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=1 

  # ---- 3. Geometry helpers ----
  {% set x_max   = printer.toolhead.axis_maximum.x|float %}
  {% set y_max   = printer.toolhead.axis_maximum.y|float %}
  {% set x_min   = printer.toolhead.axis_minimum.x|float %}
  {% set y_min   = printer.toolhead.axis_minimum.y|float %}
  {% set x_mid   = (x_max + x_min) / 2.0 %}
  {% set y_mid   = (y_max + y_min) / 2.0 %}

  # ---- 4. Heat Bed & Soak ----
  M117 Heating bed…
  M140 S{target_bed}
  M104 S150 ; Preheat nozzle slightly but don't ooze

  # ---- 5. Homing & QGL ----
  _CG28

  # Move to middle
  G90
  G1 Z20 F9000
  G1 X{x_mid} Y{y_mid} F12000

  # Wait for Bed
  M190 S{target_bed}
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={target_bed-1} MAXIMUM={target_bed+3}

  # QGL
  M117 QGL…
  QUAD_GANTRY_LEVEL
  G28 Z

  # ---- 6. Bed Mesh ----
  M117 Eddy mesh…
  BED_MESH_CLEAR
  BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1
  
  # Move clear
  G1 X{x_mid} Y{y_mid} Z10 F12000

  # ---- 7. Heat Hotend ----
  M117 Heating hotend…
  M109 S{target_extruder}

  # ---- 8. Purge Line ----
  M117 Purge lines…
  SAVE_GCODE_STATE NAME=PRIMELINE
  G90
  G92 E0
  G1 X{ (x_min + 30) if (x_min + 30) > 30 else 30 } Y{y_min + 5} Z0.3 F12000
  G91
  G1 X220 E18 F1200
  G1 Y1 F6000
  G1 X-220 E9 F1200
  G90
  G92 E0
  RESTORE_GCODE_STATE NAME=PRIMELINE

  # ============================================================
  #  ENABLE ADAPTIVE FLOW (Zero-Config)
  # ============================================================
  # AT_START automatically:
  #   - Detects material from extruder target temperature
  #   - Applies appropriate K-values and PA
  #   - Auto-calibrates baseline on first print (if needed)
  #   - Self-learns optimal settings over time
  AT_START

  M117 Printing…


[gcode_macro PRINT_END]
gcode:
    # 1. Disable Systems
    AT_END                       ; Disable Adaptive Flow (reports learned data)
    SET_FILAMENT_SENSOR SENSOR=SFS_T0 ENABLE=0
    TURN_OFF_HEATERS
    M107

    # 2. Safe Z Raise
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 20) %}
        {% set z_safe = 20.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    
    # 3. Retract & Move
    G91
    G1 E-5 F3600
    G0 Z{z_safe} F3600
    G90
    G0 X{printer.toolhead.axis_maximum.x - 10} Y{printer.toolhead.axis_maximum.y - 10} F12000
    
    # 4. Motors Off
    M84 X Y E
    M117 Print Complete.
